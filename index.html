<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•´åˆç³»çµ±ï¼šæ”¶æ¬¾æ—¥æœŸ + SMSï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆï¼‰</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Microsoft JhengHei",sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:16px
    }
    .shell{max-width:1200px;margin:0 auto;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .shell-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:22px 18px;text-align:center}
    .shell-header h1{margin:0 0 6px 0;font-size:22px;font-weight:900}
    .shell-header p{margin:0;opacity:.92;font-size:13px;line-height:1.6}
    .shell-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
    .shell-tab{flex:1;padding:14px 10px;border:0;cursor:pointer;font-weight:900;font-size:15px;background:transparent;color:#6c757d}
    .shell-tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
    .shell-content{padding:18px}
    .shell-panel{display:none}
    .shell-panel.active{display:block}
    @media (max-width:768px){body{padding:10px}.shell{border-radius:0}.shell-content{padding:12px}}

    /* Pay */
    .pay-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;border-radius:14px;overflow:hidden}
    .pay-tab{flex:1;padding:12px 10px;cursor:pointer;border:none;background:#f8f9fa;font-size:15px;font-weight:900}
    .pay-tab.active{background:#fff;color:#667eea;border-bottom:3px solid #667eea}
    .pay-panel{display:none;padding:16px 4px}
    .pay-panel.active{display:block}
    .pay-form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:768px){.pay-form-grid{grid-template-columns:1fr}}
    .pay-form-group{margin-bottom:12px}
    .pay-form-group label{display:block;margin-bottom:8px;font-weight:900;color:#333}
    .pay-input,.pay-select{width:100%;padding:10px 12px;border:2px solid #e9ecef;border-radius:12px;font-size:16px}
    .pay-input:focus,.pay-select:focus{outline:none;border-color:#667eea}
    .pay-btn{padding:10px 16px;border:0;border-radius:12px;font-weight:900;cursor:pointer}
    .pay-btn + .pay-btn{margin-left:8px}
    .pay-btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .pay-btn-secondary{background:#6c757d;color:#fff}
    .pay-btn-success{background:#28a745;color:#fff}
    .pay-btn-danger{background:#dc3545;color:#fff}
    .pay-btn-warning{background:#ffc107;color:#000}
    .pay-btn-sm{padding:6px 10px;font-size:12px;border-radius:10px}
    .pay-result{margin-top:14px;background:#f8f9fa;padding:14px;border-radius:14px;display:none}
    .pay-result h3{margin:0 0 10px 0;color:#667eea}
    .pay-result-row{display:flex;justify-content:space-between;gap:10px;background:#fff;padding:10px 12px;border-radius:12px;margin-bottom:8px}
    .pay-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:12px 0}
    .pay-stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px;border-radius:14px;text-align:center}
    .pay-stat-card h3{margin:0 0 6px 0;font-size:28px}
    .pay-stat-card p{margin:0;opacity:.95;font-size:12px}
    .pay-actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .pay-table-wrap{overflow-x:auto}
    .pay-table{width:100%;border-collapse:collapse;margin-top:10px}
    .pay-table thead{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .pay-table th,.pay-table td{padding:10px;border-bottom:1px solid #e9ecef;text-align:left;white-space:nowrap;vertical-align:middle}
    .pay-checkbox-cell{width:44px;text-align:center}
    .pay-checkbox-cell input{width:18px;height:18px;cursor:pointer}
    .pay-status-pending{color:#f0a500;font-weight:900}
    .pay-status-picked{color:#1e7e34;font-weight:900}
    .pay-pickup-inline{display:flex;align-items:center;gap:6px}
    .pay-pickup-inline input[type="date"]{width:140px;padding:6px 8px;border:1px solid #dfe3e6;border-radius:10px;font-size:12px}
    .pay-upload{border:2px dashed #667eea;padding:22px;text-align:center;border-radius:14px;cursor:pointer;user-select:none;background:#fff}
    .pay-upload:hover{background:#f8f9fa}
    .pay-upload input{display:none}
    .pay-hint{margin-top:14px;background:#f8f9fa;padding:14px;border-radius:14px;color:#444;line-height:1.7}

    /* SMS */
    .sms-reset-btn{
      position:fixed;bottom:20px;right:20px;background:#dc3545;color:#fff;
      padding:10px 20px;border-radius:50px;border:none;font-weight:900;cursor:pointer;
      box-shadow:0 4px 12px rgba(220,53,69,.4);z-index:999;display:none
    }
    .sms-container{max-width:1200px;margin:0 auto;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .sms-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:22px;text-align:center}
    .sms-header h1{margin:0 0 8px 0;font-size:24px}
    .sms-sync-status{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;font-size:14px;margin-top:8px}
    .sms-sync-indicator{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:sms_pulse 2s infinite}
    .sms-sync-indicator.offline{background:#f87171;animation:none}
    @keyframes sms_pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .sms-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
    .sms-tab{flex:1;padding:16px 10px;text-align:center;cursor:pointer;font-weight:900;color:#6c757d;border:none;background:none;font-size:15px}
    .sms-tab.active{color:#667eea;background:#fff;border-bottom:3px solid #667eea}
    .sms-tab-content{display:none;padding:18px}
    .sms-tab-content.active{display:block;animation:sms_fade .25s}
    @keyframes sms_fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .sms-form-group{margin-bottom:16px}
    .sms-form-group label{display:block;margin-bottom:8px;font-weight:900;color:#495057}
    .sms-form-group input,.sms-form-group select,.sms-form-group textarea{width:100%;padding:12px;border:2px solid #e9ecef;border-radius:12px;font-size:16px}
    .sms-form-group textarea{min-height:120px;resize:vertical}
    .sms-btn{padding:12px 18px;border:none;border-radius:12px;font-size:15px;font-weight:900;cursor:pointer;display:inline-block}
    .sms-btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .sms-btn-secondary{background:#6c757d;color:#fff}
    .sms-btn-success{background:#28a745;color:#fff}
    .sms-btn-danger{background:#dc3545;color:#fff}
    .sms-btn-warning{background:#ffc107;color:#000}
    .sms-btn-small{padding:8px 12px;font-size:13px;border-radius:10px}
    .sms-button-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .sms-order-card{background:#f8f9fa;border-radius:15px;padding:18px;margin-bottom:12px;border:2px solid #e9ecef;transition:all .2s}
    .sms-order-card:hover{border-color:#667eea;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .sms-order-card.selected{border-color:#667eea;background:#f0f4ff}
    .sms-order-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:10px}
    .sms-template-card{background:#f8f9fa;border-radius:15px;padding:18px;margin-bottom:12px;border:2px solid #e9ecef}
    .sms-template-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
    .sms-template-name{font-size:18px;font-weight:900;color:#212529}
    .sms-template-content{color:#495057;line-height:1.6;white-space:pre-wrap}
    .sms-empty-state{text-align:center;padding:50px 12px;color:#6c757d}
    .sms-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:900;margin-left:8px}
    .sms-badge-draft{background:#fff3cd;color:#856404}
    .sms-preview{background:#f8f9fa;border-radius:10px;padding:14px;margin-top:10px;border-left:4px solid #667eea}
    .sms-preview-label{font-size:12px;color:#6c757d;margin-bottom:8px;font-weight:900}
    .sms-preview-content{color:#212529;line-height:1.6;white-space:pre-wrap}
    .sms-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .sms-modal.active{display:flex}
    .sms-modal-content{background:#fff;border-radius:18px;padding:20px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto}
    .sms-modal-header{font-size:20px;font-weight:900;margin-bottom:14px;color:#212529}
    .sms-alert{padding:12px 14px;border-radius:12px;margin-bottom:14px;background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    @media (max-width:768px){
      .sms-tab-content{padding:14px}
      .sms-order-info{grid-template-columns:1fr}
      .sms-button-group{flex-direction:column}
      .sms-btn{width:100%}
    }

    /* SMS ç™¼é€é ï¼šé»æ“Šå±•é–‹ */
    .sms-send-row{display:grid;grid-template-columns:44px 1fr;gap:10px;align-items:center}
    .sms-send-left{display:flex;align-items:flex-start;justify-content:center;padding-top:4px}
    .sms-send-summary{cursor:pointer;user-select:none}
    .sms-send-summary-top{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .sms-caret{font-weight:900;color:#667eea}
    .sms-expand-area{margin-top:12px;padding-top:12px;border-top:1px solid #e9ecef;display:none}
    .sms-order-card.expanded .sms-expand-area{display:block}
    .sms-expand-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    @media (max-width:768px){.sms-expand-grid{grid-template-columns:1fr}}
    .sms-mini-label{font-size:12px;color:#6c757d;font-weight:900;margin-bottom:6px}
    .sms-inline-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .sms-kpi-box{background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:12px}
    .sms-kpi-row{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #eee;font-size:14px}
    .sms-kpi-row:last-child{border-bottom:none}
    .sms-muted{color:#6c757d}
  </style>
</head>

<body>
  <button class="sms-reset-btn" id="smsResetBtn" onclick="sms_resetTemplates()">é‡ç½®ç¯„æœ¬</button>

  <div class="shell">
    <div class="shell-header">
      <h1>æ•´åˆç³»çµ±ï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆï¼‰</h1>
      <p>
        - é–€å¸‚åˆä½µé¡¯ç¤ºï¼šè³£è²¨ä¾¿ â†’ 7-11 + é–€å¸‚åç¨±ï¼›å¥½è³£+ â†’ å…¨å®¶ + é–€å¸‚åç¨±<br/>
        - æ”¶æ¬¾ç«¯å‹¾é¸ â†’ ä¸€éµå¸¶å…¥ SMSï¼ˆä¾è¨‚å–®è™Ÿå« # å»é‡/æ›´æ–°ï¼‰<br/>
        - æ”¶æ¬¾ç«¯æ¨™è¨˜å·²å–è²¨ â†’ SMS ç«¯ä¾è¨‚å–®è™ŸåŒæ­¥åˆªé™¤
      </p>
    </div>

    <div class="shell-tabs">
      <button class="shell-tab active" onclick="mainSwitch('pay')">ğŸ§¾ æ”¶æ¬¾æ—¥æœŸ / è¨‚å–®</button>
      <button class="shell-tab" onclick="mainSwitch('sms')">ğŸ“± SMS å®¢æˆ¶ç®¡ç†</button>
    </div>

    <div class="shell-content">
      <!-- PAY -->
      <div id="main-pay" class="shell-panel active">
        <div class="pay-tabs">
          <button class="pay-tab active" onclick="pay_switchTab(event,'calc')">ğŸ“… æ—¥æœŸè¨ˆç®—å™¨</button>
          <button class="pay-tab" onclick="pay_switchTab(event,'orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
          <button class="pay-tab" onclick="pay_switchTab(event,'import')">ğŸ“Š Excel æ‰¹é‡åŒ¯å…¥</button>
        </div>

        <div id="pay-calc" class="pay-panel active">
          <div class="pay-form-group">
            <label>é¸æ“‡å¹³å°</label>
            <select id="payPlatform" class="pay-select">
              <option value="è³£è²¨ä¾¿">è³£è²¨ä¾¿</option>
              <option value="å¥½è³£+">å¥½è³£+</option>
            </select>
          </div>
          <div class="pay-form-group">
            <label>å–è²¨æ—¥æœŸ</label>
            <input type="date" id="payPickupDate" class="pay-input" />
          </div>
          <button class="pay-btn pay-btn-primary" onclick="pay_calculateDate()">è¨ˆç®—</button>

          <div id="payResult" class="pay-result">
            <h3>è¨ˆç®—çµæœ</h3>
            <div class="pay-result-row"><span>å–è²¨æ—¥æœŸ</span><strong id="payResultPickup"></strong></div>
            <div class="pay-result-row"><span>çµç®—æ—¥æœŸ</span><strong id="payResultSettlement"></strong></div>
            <div class="pay-result-row"><span>åŒ¯æ¬¾æ—¥æœŸ</span><strong id="payResultPayment"></strong></div>
          </div>

          <div class="pay-hint">é€™è£¡åªåšæ”¶æ¬¾é‚è¼¯ï¼ˆå–è²¨æ—¥ â†’ çµç®—æ—¥ â†’ åŒ¯æ¬¾æ—¥ï¼‰ã€‚</div>
        </div>

        <div id="pay-orders" class="pay-panel">
          <div class="pay-stats">
            <div class="pay-stat-card"><h3 id="payTotalOrders">0</h3><p>ç¸½è¨‚å–®æ•¸</p></div>
            <div class="pay-stat-card"><h3 id="payPendingOrders">0</h3><p>å¾…å–è²¨</p></div>
            <div class="pay-stat-card"><h3 id="payPickedOrders">0</h3><p>å·²å–è²¨</p></div>
          </div>

          <div class="pay-form-grid">
            <div class="pay-form-group">
              <label>è¨‚å–®è™Ÿ *</label>
              <input type="text" id="payOrderNumber" class="pay-input" placeholder="#1468" />
            </div>
            <div class="pay-form-group">
              <label>å§“å *</label>
              <input type="text" id="payCustomerName" class="pay-input" placeholder="ç‹å°æ˜" />
            </div>
            <div class="pay-form-group">
              <label>é›»è©± *</label>
              <input type="tel" id="payPhone" class="pay-input" placeholder="0912345678" />
            </div>
            <div class="pay-form-group">
              <label>å¹³å° *</label>
              <select id="payOrderPlatform" class="pay-select">
                <option value="è³£è²¨ä¾¿">è³£è²¨ä¾¿</option>
                <option value="å¥½è³£+">å¥½è³£+</option>
              </select>
            </div>
            <div class="pay-form-group">
              <label>é–€å¸‚åç¨±ï¼ˆé¡¯ç¤ºæ™‚æœƒè‡ªå‹•åˆä½µï¼š7-11/å…¨å®¶ + é–€å¸‚åç¨±ï¼‰</label>
              <input type="text" id="payStore" class="pay-input" placeholder="å°åŒ—è»Šç«™åº—" />
            </div>
            <div class="pay-form-group">
              <label>å‡ºè²¨æ—¥ *</label>
              <input type="date" id="payOrderShipDate" class="pay-input" />
            </div>
            <div class="pay-form-group">
              <label>å–è²¨æœŸé™</label>
              <input type="date" id="payPickupDeadline" class="pay-input" />
            </div>
          </div>

          <button class="pay-btn pay-btn-primary" onclick="pay_addOrder()">æ–°å¢è¨‚å–®</button>

          <div class="pay-actions">
            <button class="pay-btn pay-btn-warning" onclick="pay_pushSelectedToSMS()">ğŸ“¤ ä¸€éµå¸¶å…¥ SMSï¼ˆé¸å–ï¼‰</button>
            <button class="pay-btn pay-btn-success" onclick="pay_batchPickupToday()">âœ… æ‰¹é‡å–è²¨ï¼ˆå–è²¨æ—¥=ä»Šå¤©ï¼‰</button>
            <button class="pay-btn pay-btn-danger" onclick="pay_batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤</button>
            <button class="pay-btn pay-btn-secondary" onclick="pay_exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
            <button class="pay-btn pay-btn-danger" onclick="pay_clearAllOrders()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
          </div>

          <div class="pay-table-wrap">
            <table class="pay-table">
              <thead>
                <tr>
                  <th class="pay-checkbox-cell"><input type="checkbox" id="paySelectAll" onchange="pay_toggleSelectAll()" /></th>
                  <th>è¨‚å–®è™Ÿ</th>
                  <th>å§“å</th>
                  <th>é›»è©±</th>
                  <th>å¹³å°</th>
                  <th>é–€å¸‚ï¼ˆåˆä½µé¡¯ç¤ºï¼‰</th>
                  <th>å‡ºè²¨æ—¥</th>
                  <th>å–è²¨æœŸé™</th>
                  <th>å–è²¨æ—¥</th>
                  <th>çµç®—æ—¥</th>
                  <th>åŒ¯æ¬¾æ—¥</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="payOrderTableBody"></tbody>
            </table>
          </div>

          <div class="pay-hint">åˆä½µé¡¯ç¤ºè¦å‰‡ï¼šè³£è²¨ä¾¿â†’7-11ï¼›å¥½è³£+â†’å…¨å®¶ã€‚è¨‚å–®è™Ÿæœƒè‡ªå‹•æ­£è¦åŒ–æˆ <code>#xxxx</code>ã€‚</div>
        </div>

        <div id="pay-import" class="pay-panel">
          <h3 style="margin:8px 0 10px 0;">ğŸ“Š Excel æ‰¹é‡åŒ¯å…¥è¨‚å–®</h3>
          <div class="pay-upload" onclick="document.getElementById('payFileInput').click()">
            <div style="font-size:18px;font-weight:900;margin-bottom:6px;">é»æ“Šä¸Šå‚³ Excel</div>
            <div style="color:#666;font-size:13px;">æ¬„ä½ï¼šè¨‚å–®è™Ÿ / å§“å / é›»è©± / å¹³å° / é–€å¸‚ / å‡ºè²¨æ—¥ / å–è²¨æœŸé™</div>
            <input type="file" id="payFileInput" accept=".xlsx,.xls" onchange="pay_handleFileUpload(event)">
          </div>
          <div class="pay-hint">ã€Œé–€å¸‚ã€æ¬„è«‹å¡«é–€å¸‚åç¨±å³å¯ï¼ˆä¾‹å¦‚ï¼šå°åŒ—è»Šç«™åº—ï¼‰ã€‚è¡¨æ ¼æœƒåˆä½µé¡¯ç¤ºæˆï¼š7-11 å°åŒ—è»Šç«™åº— / å…¨å®¶ ä¿¡ç¾©é–€å¸‚ã€‚</div>
          <div style="margin-top:12px;">
            <button class="pay-btn pay-btn-secondary" onclick="pay_downloadTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
          </div>
        </div>
      </div>

      <!-- SMS -->
      <div id="main-sms" class="shell-panel">
        <div class="sms-container">
          <div class="sms-header">
            <h1>ğŸ“± SMS å®¢æˆ¶ç®¡ç†ç³»çµ±</h1>
            <div class="sms-sync-status">
              <div class="sms-sync-indicator" id="smsSyncIndicator"></div>
              <span id="smsSyncStatus">é›²ç«¯åŒæ­¥ä¸­...</span>
            </div>
          </div>

          <div class="sms-tabs">
            <button class="sms-tab active" onclick="sms_switchTab(event,'orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
            <button class="sms-tab" onclick="sms_switchTab(event,'templates')">ğŸ’¬ ç°¡è¨Šç¯„æœ¬</button>
            <button class="sms-tab" onclick="sms_switchTab(event,'send')">ğŸ“¤ ç™¼é€ç°¡è¨Š</button>
          </div>

          <div id="smsOrdersTab" class="sms-tab-content active">
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_showAddOrderModal()">â• æ–°å¢å–®ç­†è¨‚å–®</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_showBulkImportModal()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥</button>
              <button class="sms-btn sms-btn-success" onclick="sms_exportOrders()">ğŸ’¾ åŒ¯å‡ºè¨‚å–®</button>
              <button class="sms-btn sms-btn-danger" onclick="sms_clearAllOrders()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
            </div>
            <div id="smsOrdersList"></div>
          </div>

          <div id="smsTemplatesTab" class="sms-tab-content">
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_showAddTemplateModal()">â• æ–°å¢ç¯„æœ¬</button>
              <button class="sms-btn sms-btn-success" onclick="sms_exportTemplates()">ğŸ’¾ åŒ¯å‡ºç¯„æœ¬</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_importTemplates()">ğŸ“¥ åŒ¯å…¥ç¯„æœ¬</button>
            </div>
            <div id="smsTemplatesList"></div>
          </div>

          <div id="smsSendTab" class="sms-tab-content">
            <div class="sms-form-group">
              <label><input type="checkbox" id="smsSelectAllOrders" onchange="sms_toggleSelectAll()"> å…¨é¸æ‰€æœ‰è¨‚å–®</label>
            </div>

            <div class="sms-form-group">
              <label>é¸æ“‡ç°¡è¨Šç¯„æœ¬</label>
              <select id="smsTemplateSelect" onchange="sms_previewTemplate()">
                <option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>
              </select>
            </div>

            <div class="sms-form-group">
              <label>ç¯„æœ¬å…§å®¹ï¼ˆå¯ç·¨è¼¯ï¼‰</label>
              <textarea id="smsTemplatePreview" placeholder="é¸æ“‡ç¯„æœ¬å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
            </div>

            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_applyTemplateToSelected()">âœ… å¥—ç”¨åˆ°é¸å–çš„å®¢æˆ¶</button>
              <button class="sms-btn sms-btn-warning" onclick="sms_saveDrafts()">ğŸ’¾ å„²å­˜è‰ç¨¿</button>
              <button class="sms-btn sms-btn-success" onclick="sms_startSending()">ğŸ“¤ é–‹å§‹ç™¼é€ç°¡è¨Š</button>
            </div>

            <div id="smsSendOrdersList"></div>
          </div>
        </div>

        <!-- Modals -->
        <div id="smsAddOrderModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ–°å¢è¨‚å–®</div>
            <div class="sms-form-group"><label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label><input type="tel" id="smsOrderPhone" placeholder="0912345678"></div>
            <div class="sms-form-group"><label>å®¢æˆ¶å§“å *</label><input type="text" id="smsOrderName" placeholder="ç‹å°æ˜"></div>
            <div class="sms-form-group"><label>è¨‚å–®è™Ÿç¢¼</label><input type="text" id="smsOrderNumber" placeholder="#1468"></div>
            <div class="sms-form-group">
              <label>é–€å¸‚é¡åˆ¥</label>
              <select id="smsOrderStoreType">
                <option value="å…¨å®¶">å…¨å®¶</option>
                <option value="7-11">7-11</option>
                <option value="èŠçˆ¾å¯Œ">èŠçˆ¾å¯Œ</option>
                <option value="OKè¶…å•†">OKè¶…å•†</option>
              </select>
            </div>
            <div class="sms-form-group"><label>é–€å¸‚åç¨±</label><input type="text" id="smsOrderStoreName" placeholder="å°åŒ—è»Šç«™åº—"></div>
            <div class="sms-form-group"><label>å–è²¨æœŸé™</label><input type="date" id="smsOrderDeadline"></div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_addOrder()">âœ… ç¢ºèªæ–°å¢</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsAddOrderModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <div id="smsBulkImportModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ‰¹é‡åŒ¯å…¥è¨‚å–®</div>
            <div class="sms-alert">è«‹è²¼ä¸Š Excel è³‡æ–™ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ã€å§“åã€è¨‚å–®è™Ÿç¢¼ã€é–€å¸‚é¡åˆ¥ã€é–€å¸‚åç¨±ã€å–è²¨æœŸé™ï¼ˆTab æˆ–é€—è™Ÿåˆ†éš”ï¼‰</div>
            <div class="sms-form-group">
              <label>è²¼ä¸Šè³‡æ–™</label>
              <textarea id="smsBulkImportData" rows="10" placeholder="0912345678	ç‹å°æ˜	#1468	7-11	å°åŒ—è»Šç«™åº—	2026/01/20"></textarea>
            </div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_bulkImport()">âœ… ç¢ºèªåŒ¯å…¥</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsBulkImportModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <div id="smsAddTemplateModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ–°å¢ç°¡è¨Šç¯„æœ¬</div>
            <div class="sms-alert">å¯ç”¨è®Šæ•¸ï¼š{customerName}ã€{orderNumber}ã€{storeType}ã€{storeName}ã€{pickupDeadline}</div>
            <div class="sms-form-group"><label>ç¯„æœ¬åç¨± *</label><input type="text" id="smsTemplateName" placeholder="å–è²¨é€šçŸ¥"></div>
            <div class="sms-form-group"><label>ç¯„æœ¬å…§å®¹ *</label><textarea id="smsTemplateContent" placeholder="è¦ªæ„›çš„{customerName}æ‚¨å¥½..."></textarea></div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_addTemplate()">âœ… ç¢ºèªæ–°å¢</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsAddTemplateModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <div id="smsEditSmsModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">ç·¨è¼¯ç°¡è¨Šå…§å®¹</div>
            <div class="sms-form-group"><label>å®¢æˆ¶ï¼š<span id="smsEditSmsCustomer"></span></label></div>
            <div class="sms-form-group"><label>ç°¡è¨Šå…§å®¹</label><textarea id="smsEditSmsContent" rows="6"></textarea></div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_saveEditedSms()">âœ… å„²å­˜</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsEditSmsModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /* ===== Main Switch ===== */
    function mainSwitch(which) {
      document.querySelectorAll('.shell-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.shell-panel').forEach(p => p.classList.remove('active'));
      if (which === 'pay') {
        document.querySelectorAll('.shell-tab')[0].classList.add('active');
        document.getElementById('main-pay').classList.add('active');
        document.getElementById('smsResetBtn').style.display = 'none';
      } else {
        document.querySelectorAll('.shell-tab')[1].classList.add('active');
        document.getElementById('main-sms').classList.add('active');
        document.getElementById('smsResetBtn').style.display = 'block';
      }
    }

    /* ===== Pay ===== */
    function pay_switchTab(evt, tabName) {
      document.querySelectorAll('.pay-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.pay-panel').forEach(p => p.classList.remove('active'));
      evt.target.classList.add('active');
      document.getElementById('pay-' + tabName).classList.add('active');
      if (tabName === 'orders') pay_loadOrders();
    }

    function pay_pad2(n){ return String(n).padStart(2,'0'); }
    function pay_formatDate(d){ return `${d.getFullYear()}/${pay_pad2(d.getMonth()+1)}/${pay_pad2(d.getDate())}`; }
    function pay_formatDateInput(d){ return `${d.getFullYear()}-${pay_pad2(d.getMonth()+1)}-${pay_pad2(d.getDate())}`; }
    function pay_weekday(d){ return ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()]; }
    function pay_addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
    function pay_nextWeekday(date, targetDay){
      const d=new Date(date);
      const cur=d.getDay();
      let add=targetDay-cur;
      if(add<=0) add+=7;
      d.setDate(d.getDate()+add);
      return d;
    }
    function pay_normalizeOrderNumber(raw){
      const s = String(raw || '').trim();
      if(!s) return '';
      return s.startsWith('#') ? s : ('#' + s);
    }
    function pay_normalizePhone(p){ return String(p || '').trim().replace(/\s+/g,''); }

    function pay_stripStorePrefix(storeName){
      let s = String(storeName || '').trim();
      if (!s) return '';
      s = s.replace(/^(7-11|å…¨å®¶|èŠçˆ¾å¯Œ|OKè¶…å•†|OKä¾¿åˆ©å•†åº—|OK)\s*/,'');
      return s.trim();
    }
    function pay_getStoreNameAny(o){
      const a = pay_stripStorePrefix(o && o.storeName);
      if (a) return a;
      const b = pay_stripStorePrefix(o && o.store);
      if (b) return b;
      return '';
    }
    function pay_migrateOrdersStoreField(orders){
      let changed = false;
      for (const o of orders) {
        if (!o) continue;
        if ((!o.storeName || !String(o.storeName).trim()) && o.store && String(o.store).trim()) {
          o.storeName = String(o.store).trim();
          changed = true;
        }
        const stripped = pay_stripStorePrefix(o.storeName);
        if (o.storeName !== stripped) { o.storeName = stripped; changed = true; }
      }
      return changed;
    }

    function pay_storeTypeFromPlatform(platform){
      const p = String(platform || '').trim();
      if (p === 'è³£è²¨ä¾¿') return '7-11';
      if (p === 'å¥½è³£+') return 'å…¨å®¶';
      return '';
    }
    function pay_storeMerged(platform, storeName){
      const type = pay_storeTypeFromPlatform(platform);
      const name = pay_stripStorePrefix(storeName);
      if (!type && !name) return '';
      if (!type) return name;
      if (!name) return type;
      return `${type} ${name}`;
    }

    function pay_parseExcelDate(value){
      if(value instanceof Date) return value;
      if(typeof value === 'number' && isFinite(value)){
        const excelEpoch = new Date(1899,11,30);
        return new Date(excelEpoch.getTime() + value*86400000);
      }
      if(typeof value === 'string'){
        const s=value.trim();
        if(!s) return null;
        const m=s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if(m){
          const d=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
          return isNaN(d.getTime())?null:d;
        }
        const d2=new Date(s);
        return isNaN(d2.getTime())?null:d2;
      }
      return null;
    }

    function pay_calculatePayment(platform, pickupDate){
      const dow = pickupDate.getDay();
      let settlement, payment;
      if(platform === 'è³£è²¨ä¾¿'){
        if(dow >= 1 && dow <= 3){
          settlement = pay_nextWeekday(pickupDate, 4);
          payment = pay_addDays(settlement, 4);
        } else {
          settlement = pay_nextWeekday(pickupDate, 1);
          payment = pay_addDays(settlement, 2);
        }
      } else if(platform === 'å¥½è³£+'){
        if(dow >= 1 && dow <= 3){
          settlement = pay_nextWeekday(pickupDate, 5);
          payment = pay_addDays(settlement, 4);
        } else {
          settlement = pay_nextWeekday(pickupDate, 3);
          payment = pay_addDays(settlement, 1);
        }
      }
      return { settlement, payment };
    }

    function pay_calculateDate(){
      const platform = document.getElementById('payPlatform').value;
      const pickupStr = document.getElementById('payPickupDate').value;
      if(!pickupStr) return alert('è«‹é¸æ“‡å–è²¨æ—¥æœŸ');
      const pickup = new Date(pickupStr);
      if(isNaN(pickup.getTime())) return alert('å–è²¨æ—¥æœŸæ ¼å¼éŒ¯èª¤');

      const r = pay_calculatePayment(platform, pickup);
      if(!r.settlement || !r.payment) return alert('å¹³å°è¨­å®šç•°å¸¸ï¼Œç„¡æ³•è¨ˆç®—');

      document.getElementById('payResultPickup').textContent = `${pay_formatDate(pickup)} (${pay_weekday(pickup)})`;
      document.getElementById('payResultSettlement').textContent = `${pay_formatDate(r.settlement)} (${pay_weekday(r.settlement)})`;
      document.getElementById('payResultPayment').textContent = `${pay_formatDate(r.payment)} (${pay_weekday(r.payment)})`;
      document.getElementById('payResult').style.display = 'block';
    }

    function pay_getOrders(){
      try {
        const orders = JSON.parse(localStorage.getItem('pay_orders_final') || '[]');
        const changed = pay_migrateOrdersStoreField(orders);
        if (changed) localStorage.setItem('pay_orders_final', JSON.stringify(orders));
        return orders;
      } catch {
        return [];
      }
    }
    function pay_saveOrders(orders){ localStorage.setItem('pay_orders_final', JSON.stringify(orders)); }

    function pay_addOrder(){
      const orderNumber = pay_normalizeOrderNumber(document.getElementById('payOrderNumber').value);
      const customerName = document.getElementById('payCustomerName').value.trim();
      const phone = pay_normalizePhone(document.getElementById('payPhone').value);
      const platform = document.getElementById('payOrderPlatform').value;
      const storeName = pay_stripStorePrefix(document.getElementById('payStore').value);
      const shipStr = document.getElementById('payOrderShipDate').value;
      const deadlineStr = document.getElementById('payPickupDeadline').value;

      if(!orderNumber) return alert('è«‹è¼¸å…¥è¨‚å–®è™Ÿ');
      if(!customerName) return alert('è«‹è¼¸å…¥å§“å');
      if(!phone) return alert('è«‹è¼¸å…¥é›»è©±');
      if(!shipStr) return alert('è«‹é¸æ“‡å‡ºè²¨æ—¥');

      const ship = new Date(shipStr);
      if(isNaN(ship.getTime())) return alert('å‡ºè²¨æ—¥æ ¼å¼éŒ¯èª¤');

      let pickupDeadline = '';
      if (deadlineStr) {
        const d = new Date(deadlineStr);
        if (!isNaN(d.getTime())) pickupDeadline = pay_formatDateInput(d);
      }

      const orders = pay_getOrders();
      orders.push({
        id: Date.now() + Math.random(),
        orderNumber, customerName, phone, platform, storeName,
        shipDate: pay_formatDate(ship),
        pickupDeadline,
        pickupDate: '-', settlementDate: '-', paymentDate: '-',
        status: 'å¾…å–è²¨'
      });
      pay_saveOrders(orders);

      document.getElementById('payOrderNumber').value = '';
      document.getElementById('payCustomerName').value = '';
      document.getElementById('payPhone').value = '';
      document.getElementById('payStore').value = '';
      document.getElementById('payOrderShipDate').value = '';
      document.getElementById('payPickupDeadline').value = '';

      pay_loadOrders();
    }

    function pay_deleteOrder(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')) return;
      let orders = pay_getOrders();
      orders = orders.filter(o => o.id !== id);
      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_syncDeleteSMS(orderNumbers){
      if (window.sms_removeOrdersByOrderNumbers && Array.isArray(orderNumbers) && orderNumbers.length > 0) {
        window.sms_removeOrdersByOrderNumbers(orderNumbers.map(pay_normalizeOrderNumber));
      }
    }

    function pay_savePickupDate(id){
      const input = document.querySelector(`input[data-pay-pickup="${id}"]`);
      if(!input || !input.value) return alert('è«‹é¸æ“‡å–è²¨æ—¥æœŸ');
      const pickup = new Date(input.value);
      if(isNaN(pickup.getTime())) return alert('å–è²¨æ—¥æœŸæ ¼å¼éŒ¯èª¤');

      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      const r = pay_calculatePayment(o.platform, pickup);
      o.pickupDate = pay_formatDate(pickup);
      o.settlementDate = pay_formatDate(r.settlement);
      o.paymentDate = pay_formatDate(r.payment);
      o.status = 'å·²å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();
      pay_syncDeleteSMS([o.orderNumber]);
    }

    function pay_pickupToday(id){
      const today = new Date();
      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      const r = pay_calculatePayment(o.platform, today);
      o.pickupDate = pay_formatDate(today);
      o.settlementDate = pay_formatDate(r.settlement);
      o.paymentDate = pay_formatDate(r.payment);
      o.status = 'å·²å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();
      pay_syncDeleteSMS([o.orderNumber]);
    }

    function pay_resetPickup(id){
      if(!confirm('è¦é‡è¨­å–è²¨è³‡è¨Šå—ï¼Ÿï¼ˆçµç®—/åŒ¯æ¬¾ä¹Ÿæœƒæ¸…ç©ºï¼‰')) return;
      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      o.pickupDate = '-';
      o.settlementDate = '-';
      o.paymentDate = '-';
      o.status = 'å¾…å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_toggleSelectAll(){
      const all = document.getElementById('paySelectAll').checked;
      document.querySelectorAll('.pay-order-checkbox').forEach(cb => cb.checked = all);
    }
    function pay_selectedIds(){
      return Array.from(document.querySelectorAll('.pay-order-checkbox:checked'))
        .map(cb => Number(cb.getAttribute('data-id')))
        .filter(n => !Number.isNaN(n));
    }

    function pay_batchPickupToday(){
      const ids = pay_selectedIds();
      if(ids.length === 0) return alert('è«‹å…ˆå‹¾é¸è¦å–è²¨çš„è¨‚å–®');
      if(!confirm(`ç¢ºå®šè¦å°‡ ${ids.length} ç­†è¨‚å–®å–è²¨æ—¥è¨­ç‚ºä»Šå¤©å—ï¼Ÿ`)) return;

      const today = new Date();
      const orders = pay_getOrders();
      const pickedOrderNumbers = [];

      orders.forEach(o => {
        if(!ids.includes(o.id)) return;
        if(o.status !== 'å¾…å–è²¨') return;
        const r = pay_calculatePayment(o.platform, today);
        o.pickupDate = pay_formatDate(today);
        o.settlementDate = pay_formatDate(r.settlement);
        o.paymentDate = pay_formatDate(r.payment);
        o.status = 'å·²å–è²¨';
        pickedOrderNumbers.push(o.orderNumber);
      });

      pay_saveOrders(orders);
      pay_loadOrders();
      pay_syncDeleteSMS(pickedOrderNumbers);
    }

    function pay_batchDelete(){
      const ids = pay_selectedIds();
      if(ids.length === 0) return alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è¨‚å–®');
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${ids.length} ç­†è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

      let orders = pay_getOrders();
      orders = orders.filter(o => !ids.includes(o.id));
      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_clearAllOrders(){
      if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      localStorage.removeItem('pay_orders_final');
      pay_loadOrders();
    }

    function pay_loadOrders(){
      const orders = pay_getOrders();
      const tbody = document.getElementById('payOrderTableBody');
      tbody.innerHTML = '';

      let pending = 0, picked = 0;
      orders.forEach(o => {
        if(o.status === 'å¾…å–è²¨') pending++;
        if(o.status === 'å·²å–è²¨') picked++;

        const tr = document.createElement('tr');

        const td0 = document.createElement('td');
        td0.className = 'pay-checkbox-cell';
        td0.innerHTML = `<input type="checkbox" class="pay-order-checkbox" data-id="${o.id}">`;
        tr.appendChild(td0);

        const td1 = document.createElement('td'); td1.textContent = o.orderNumber || ''; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = o.customerName || ''; tr.appendChild(td2);
        const td3 = document.createElement('td'); td3.textContent = o.phone || ''; tr.appendChild(td3);
        const td4 = document.createElement('td'); td4.textContent = o.platform || ''; tr.appendChild(td4);

        const td5 = document.createElement('td');
        td5.textContent = pay_storeMerged(o.platform, pay_getStoreNameAny(o));
        tr.appendChild(td5);

        const td6 = document.createElement('td'); td6.textContent = o.shipDate || ''; tr.appendChild(td6);

        const td7 = document.createElement('td');
        td7.textContent = o.pickupDeadline ? o.pickupDeadline : '-';
        tr.appendChild(td7);

        const td8 = document.createElement('td');
        if(o.status === 'å¾…å–è²¨'){
          td8.innerHTML = `
            <div class="pay-pickup-inline">
              <input type="date" data-pay-pickup="${o.id}">
              <button class="pay-btn pay-btn-primary pay-btn-sm" onclick="pay_savePickupDate(${o.id})">å„²å­˜</button>
              <button class="pay-btn pay-btn-success pay-btn-sm" onclick="pay_pickupToday(${o.id})">ä»Šå¤©</button>
            </div>
          `;
        } else {
          td8.innerHTML = `${o.pickupDate} <button class="pay-btn pay-btn-secondary pay-btn-sm" onclick="pay_resetPickup(${o.id})">é‡è¨­</button>`;
        }
        tr.appendChild(td8);

        const td9 = document.createElement('td'); td9.textContent = o.settlementDate || '-'; tr.appendChild(td9);
        const td10 = document.createElement('td'); td10.textContent = o.paymentDate || '-'; tr.appendChild(td10);

        const td11 = document.createElement('td');
        td11.className = (o.status === 'å¾…å–è²¨') ? 'pay-status-pending' : 'pay-status-picked';
        td11.textContent = o.status;
        tr.appendChild(td11);

        const td12 = document.createElement('td');
        td12.innerHTML = `<button class="pay-btn pay-btn-danger pay-btn-sm" onclick="pay_deleteOrder(${o.id})">åˆªé™¤</button>`;
        tr.appendChild(td12);

        tbody.appendChild(tr);
      });

      document.getElementById('payTotalOrders').textContent = orders.length;
      document.getElementById('payPendingOrders').textContent = pending;
      document.getElementById('payPickedOrders').textContent = picked;
    }

    function pay_exportToExcel() {
      const orders = pay_getOrders();
      if (orders.length === 0) {
        alert('æ²’æœ‰è¨‚å–®å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(orders.map(o => ({
        è¨‚å–®è™Ÿ: o.orderNumber,
        å§“å: o.customerName,
        é›»è©±: o.phone,
        å¹³å°: o.platform,
        é–€å¸‚: pay_storeMerged(o.platform, pay_getStoreNameAny(o)),
        å‡ºè²¨æ—¥: o.shipDate,
        å–è²¨æœŸé™: o.pickupDeadline,
        å–è²¨æ—¥: o.pickupDate,
        çµç®—æ—¥: o.settlementDate,
        åŒ¯æ¬¾æ—¥: o.paymentDate,
        ç‹€æ…‹: o.status
      })));

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'è¨‚å–®');
      XLSX.writeFile(workbook, 'è¨‚å–®åŒ¯å‡º.xlsx');
    }

    function pay_downloadTemplate() {
      const templateData = [{
        è¨‚å–®è™Ÿ: '#1468',
        å§“å: 'ç‹å°æ˜',
        é›»è©±: '0912345678',
        å¹³å°: 'è³£è²¨ä¾¿',
        é–€å¸‚: 'å°åŒ—è»Šç«™åº—',
        å‡ºè²¨æ—¥: '2026/01/15',
        å–è²¨æœŸé™: '2026/01/20'
      }];
      const worksheet = XLSX.utils.json_to_sheet(templateData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'ç¯„æœ¬');
      XLSX.writeFile(workbook, 'è¨‚å–®åŒ¯å…¥ç¯„æœ¬.xlsx');
    }

    function pay_handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) {
          alert('Excel æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™ï¼');
          return;
        }

        const orders = pay_getOrders();
        let addedCount = 0;

        jsonData.forEach(row => {
          const orderNumber = pay_normalizeOrderNumber(row['è¨‚å–®è™Ÿ']);
          const customerName = String(row['å§“å'] || '').trim();
          const phone = pay_normalizePhone(row['é›»è©±']);
          const platform = String(row['å¹³å°'] || '').trim();
          const storeName = pay_stripStorePrefix(row['é–€å¸‚']);
          const shipDateRaw = row['å‡ºè²¨æ—¥'];
          const deadlineRaw = row['å–è²¨æœŸé™'];

          if (!orderNumber || !customerName || !phone || !platform || !shipDateRaw) {
            console.log('å¿½ç•¥ä¸å®Œæ•´çš„è³‡æ–™è¡Œ', row);
            return;
          }

          const shipDate = pay_parseExcelDate(shipDateRaw);
          if (!shipDate || isNaN(shipDate.getTime())) {
            console.log('å‡ºè²¨æ—¥æ ¼å¼éŒ¯èª¤', row);
            return;
          }

          let pickupDeadline = '';
          if (deadlineRaw) {
            const d = pay_parseExcelDate(deadlineRaw);
            if (d && !isNaN(d.getTime())) {
              pickupDeadline = pay_formatDateInput(d);
            }
          }

          orders.push({
            id: Date.now() + Math.random(),
            orderNumber,
            customerName,
            phone,
            platform,
            storeName,
            shipDate: pay_formatDate(shipDate),
            pickupDeadline,
            pickupDate: '-',
            settlementDate: '-',
            paymentDate: '-',
            status: 'å¾…å–è²¨'
          });
          addedCount++;
        });

        pay_saveOrders(orders);
        pay_loadOrders();
        alert(`æˆåŠŸåŒ¯å…¥ ${addedCount} ç­†è¨‚å–®ï¼`);
        event.target.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    function pay_pushSelectedToSMS() {
      const ids = pay_selectedIds();
      if (ids.length === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦å¸¶å…¥ SMS çš„è¨‚å–®');
        return;
      }

      const orders = pay_getOrders();
      const selectedOrders = orders.filter(o => ids.includes(o.id));
      const smsOrders = selectedOrders.map(o => ({
        id: Date.now() + Math.random(),
        orderNumber: o.orderNumber,
        customerName: o.customerName,
        phone: o.phone,
        storeType: pay_storeTypeFromPlatform(o.platform),
        storeName: pay_getStoreNameAny(o),
        pickupDeadline: o.pickupDeadline || '',
        smsContent: '',
        selected: false
      }));

      let existingSmsOrders = sms_getOrders();
      smsOrders.forEach(newOrder => {
        const index = existingSmsOrders.findIndex(eo => eo.orderNumber === newOrder.orderNumber);
        if (index >= 0) {
          existingSmsOrders[index] = newOrder;
        } else {
          existingSmsOrders.push(newOrder);
        }
      });
      sms_saveOrders(existingSmsOrders);
      alert(`å·²å°‡ ${smsOrders.length} ç­†è¨‚å–®å¸¶å…¥ SMS ç³»çµ±ï¼ˆä¾è¨‚å–®è™Ÿå»é‡/æ›´æ–°ï¼‰`);
      sms_renderOrdersList();
    }

    /* ===== SMS ===== */
    function sms_switchTab(evt, tabName) {
      document.querySelectorAll('.sms-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sms-tab-content').forEach(p => p.classList.remove('active'));
      evt.target.classList.add('active');
      document.getElementById('sms' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
      if (tabName === 'orders') {
        sms_renderOrdersList();
      } else if (tabName === 'templates') {
        sms_renderTemplatesList();
      } else if (tabName === 'send') {
        sms_renderSendOrdersList();
        sms_renderTemplateSelect();
      }
    }

    function sms_getOrders() {
      try {
        return JSON.parse(localStorage.getItem('sms_orders') || '[]');
      } catch {
        return [];
      }
    }

    function sms_saveOrders(orders) {
      localStorage.setItem('sms_orders', JSON.stringify(orders));
    }

    function sms_removeOrdersByOrderNumbers(orderNumbers) {
      if (!Array.isArray(orderNumbers) || orderNumbers.length === 0) return;
      const normalizedNumbers = orderNumbers.map(pay_normalizeOrderNumber);
      let orders = sms_getOrders();
      const originalLength = orders.length;
      orders = orders.filter(o => !normalizedNumbers.includes(o.orderNumber));
      if (orders.length !== originalLength) {
        sms_saveOrders(orders);
        sms_renderOrdersList();
        sms_renderSendOrdersList();
      }
    }

    function sms_showAddOrderModal() {
      document.getElementById('smsOrderPhone').value = '';
      document.getElementById('smsOrderName').value = '';
      document.getElementById('smsOrderNumber').value = '';
      document.getElementById('smsOrderStoreType').value = 'å…¨å®¶';
      document.getElementById('smsOrderStoreName').value = '';
      document.getElementById('smsOrderDeadline').value = '';
      document.getElementById('smsAddOrderModal').classList.add('active');
    }

    function sms_closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function sms_addOrder() {
      const phone = pay_normalizePhone(document.getElementById('smsOrderPhone').value);
      const name = document.getElementById('smsOrderName').value.trim();
      const orderNumber = pay_normalizeOrderNumber(document.getElementById('smsOrderNumber').value);
      const storeType = document.getElementById('smsOrderStoreType').value;
      const storeName = pay_stripStorePrefix(document.getElementById('smsOrderStoreName').value);
      const deadline = document.getElementById('smsOrderDeadline').value;

      if (!phone) return alert('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
      if (!name) return alert('è«‹è¼¸å…¥å®¢æˆ¶å§“å');

      const orders = sms_getOrders();
      orders.push({
        id: Date.now() + Math.random(),
        phone,
        customerName: name,
        orderNumber,
        storeType,
        storeName,
        pickupDeadline: deadline ? pay_formatDate(new Date(deadline)) : '',
        smsContent: '',
        selected: false
      });
      sms_saveOrders(orders);
      sms_closeModal('smsAddOrderModal');
      sms_renderOrdersList();
    }

    function sms_renderOrdersList() {
      const orders = sms_getOrders();
      const list = document.getElementById('smsOrdersList');
      list.innerHTML = '';

      if (orders.length === 0) {
        list.innerHTML = '<div class="sms-empty-state">å°šç„¡è¨‚å–®è³‡æ–™ï¼Œè«‹æ–°å¢æˆ–åŒ¯å…¥è¨‚å–®ã€‚</div>';
        return;
      }

      orders.forEach(o => {
        const card = document.createElement('div');
        card.className = 'sms-order-card';
        card.innerHTML = `
          <div class="sms-order-info">
            <div><strong>å§“åï¼š</strong> ${o.customerName}</div>
            <div><strong>é›»è©±ï¼š</strong> ${o.phone}</div>
            <div><strong>è¨‚å–®è™Ÿï¼š</strong> ${o.orderNumber || '-'}</div>
            <div><strong>é–€å¸‚ï¼š</strong> ${o.storeType} ${o.storeName || '-'}</div>
            <div><strong>å–è²¨æœŸé™ï¼š</strong> ${o.pickupDeadline || '-'}</div>
          </div>
          <div class="sms-button-group">
            <button class="sms-btn sms-btn-small sms-btn-danger" onclick="sms_deleteOrder(${o.id})">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        `;
        list.appendChild(card);
      });
    }

    function sms_deleteOrder(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')) return;
      let orders = sms_getOrders();
      orders = orders.filter(o => o.id !== id);
      sms_saveOrders(orders);
      sms_renderOrdersList();
    }

    function sms_clearAllOrders() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      localStorage.removeItem('sms_orders');
      sms_renderOrdersList();
    }

    function sms_showBulkImportModal() {
      document.getElementById('smsBulkImportData').value = '';
      document.getElementById('smsBulkImportModal').classList.add('active');
    }

    function sms_bulkImport() {
      const dataText = document.getElementById('smsBulkImportData').value.trim();
      if (!dataText) {
        alert('è«‹è²¼ä¸Šè³‡æ–™');
        return;
      }

      const lines = dataText.split('\n');
      if (lines.length === 0) {
        alert('è³‡æ–™æ ¼å¼éŒ¯èª¤');
        return;
      }

      const orders = sms_getOrders();
      let addedCount = 0;

      lines.forEach(line => {
        const parts = line.split(/[\t,]/);
        if (parts.length < 2) return;

        const phone = pay_normalizePhone(parts[0]);
        const name = String(parts[1] || '').trim();
        const orderNumber = parts[2] ? pay_normalizeOrderNumber(parts[2]) : '';
        const storeType = parts[3] ? String(parts[3]).trim() : 'å…¨å®¶';
        const storeName = parts[4] ? pay_stripStorePrefix(parts[4]) : '';
        const deadlineRaw = parts[5] ? String(parts[5]).trim() : '';

        if (!phone || !name) return;

        let pickupDeadline = '';
        if (deadlineRaw) {
          const d = pay_parseExcelDate(deadlineRaw);
          if (d && !isNaN(d.getTime())) {
            pickupDeadline = pay_formatDate(d);
          }
        }

        orders.push({
          id: Date.now() + Math.random(),
          phone,
          customerName: name,
          orderNumber,
          storeType,
          storeName,
          pickupDeadline,
          smsContent: '',
          selected: false
        });
        addedCount++;
      });

      if (addedCount === 0) {
        alert('æ²’æœ‰æœ‰æ•ˆè³‡æ–™è¢«åŒ¯å…¥ï¼Œè«‹æª¢æŸ¥æ ¼å¼');
        return;
      }

      sms_saveOrders(orders);
      sms_closeModal('smsBulkImportModal');
      sms_renderOrdersList();
      alert(`æˆåŠŸåŒ¯å…¥ ${addedCount} ç­†è¨‚å–®ï¼`);
    }

    function sms_exportOrders() {
      const orders = sms_getOrders();
      if (orders.length === 0) {
        alert('æ²’æœ‰è¨‚å–®å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(orders.map(o => ({
        æ‰‹æ©Ÿè™Ÿç¢¼: o.phone,
        å§“å: o.customerName,
        è¨‚å–®è™Ÿç¢¼: o.orderNumber,
        é–€å¸‚é¡åˆ¥: o.storeType,
        é–€å¸‚åç¨±: o.storeName,
        å–è²¨æœŸé™: o.pickupDeadline
      })));

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'SMSè¨‚å–®');
      XLSX.writeFile(workbook, 'SMSè¨‚å–®åŒ¯å‡º.xlsx');
    }

    function sms_getTemplates() {
      try {
        return JSON.parse(localStorage.getItem('sms_templates') || '[]');
      } catch {
        return [];
      }
    }

    function sms_saveTemplates(templates) {
      localStorage.setItem('sms_templates', JSON.stringify(templates));
    }

    function sms_showAddTemplateModal() {
      document.getElementById('smsTemplateName').value = '';
      document.getElementById('smsTemplateContent').value = '';
      document.getElementById('smsAddTemplateModal').classList.add('active');
    }

    function sms_addTemplate() {
      const name = document.getElementById('smsTemplateName').value.trim();
      const content = document.getElementById('smsTemplateContent').value.trim();

      if (!name) return alert('è«‹è¼¸å…¥ç¯„æœ¬åç¨±');
      if (!content) return alert('è«‹è¼¸å…¥ç¯„æœ¬å…§å®¹');

      const templates = sms_getTemplates();
      templates.push({
        id: Date.now() + Math.random(),
        name,
        content
      });
      sms_saveTemplates(templates);
      sms_closeModal('smsAddTemplateModal');
      sms_renderTemplatesList();
    }

    function sms_renderTemplatesList() {
      const templates = sms_getTemplates();
      const list = document.getElementById('smsTemplatesList');
      list.innerHTML = '';

      if (templates.length === 0) {
        list.innerHTML = '<div class="sms-empty-state">å°šç„¡ç¯„æœ¬ï¼Œè«‹æ–°å¢æˆ–åŒ¯å…¥ç¯„æœ¬ã€‚</div>';
        return;
      }

      templates.forEach(t => {
        const card = document.createElement('div');
        card.className = 'sms-template-card';
        card.innerHTML = `
          <div class="sms-template-header">
            <div class="sms-template-name">${t.name}</div>
            <div>
              <button class="sms-btn sms-btn-small sms-btn-danger" onclick="sms_deleteTemplate(${t.id})">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
          </div>
          <div class="sms-template-content">${t.content}</div>
        `;
        list.appendChild(card);
      });
    }

    function sms_deleteTemplate(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¯„æœ¬å—ï¼Ÿ')) return;
      let templates = sms_getTemplates();
      templates = templates.filter(t => t.id !== id);
      sms_saveTemplates(templates);
      sms_renderTemplatesList();
    }

    function sms_exportTemplates() {
      const templates = sms_getTemplates();
      if (templates.length === 0) {
        alert('æ²’æœ‰ç¯„æœ¬å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(templates.map(t => ({
        ç¯„æœ¬åç¨±: t.name,
        ç¯„æœ¬å…§å®¹: t.content
      })));

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'ç°¡è¨Šç¯„æœ¬');
      XLSX.writeFile(workbook, 'ç°¡è¨Šç¯„æœ¬åŒ¯å‡º.xlsx');
    }

    function sms_importTemplates() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          if (jsonData.length === 0) {
            alert('Excel æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™ï¼');
            return;
          }

          const templates = sms_getTemplates();
          let addedCount = 0;

          jsonData.forEach(row => {
            const name = String(row['ç¯„æœ¬åç¨±'] || '').trim();
            const content = String(row['ç¯„æœ¬å…§å®¹'] || '').trim();

            if (!name || !content) return;

            templates.push({
              id: Date.now() + Math.random(),
              name,
              content
            });
            addedCount++;
          });

          sms_saveTemplates(templates);
          sms_renderTemplatesList();
          alert(`æˆåŠŸåŒ¯å…¥ ${addedCount} å€‹ç¯„æœ¬ï¼`);
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    }

    function sms_resetTemplates() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®ç¯„æœ¬å—ï¼Ÿæ­¤æ“ä½œæœƒæ¸…ç©ºæ‰€æœ‰ç¯„æœ¬ï¼')) return;
      localStorage.removeItem('sms_templates');
      sms_renderTemplatesList();
    }

    function sms_renderTemplateSelect() {
      const templates = sms_getTemplates();
      const select = document.getElementById('smsTemplateSelect');
      select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>';

      templates.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        select.appendChild(option);
      });
    }

    function sms_previewTemplate() {
      const templateId = document.getElementById('smsTemplateSelect').value;
      if (!templateId) {
        document.getElementById('smsTemplatePreview').value = '';
        return;
      }

      const templates = sms_getTemplates();
      const template = templates.find(t => t.id == templateId);
      if (template) {
        document.getElementById('smsTemplatePreview').value = template.content;
      }
    }

    function sms_toggleSelectAll() {
      const checked = document.getElementById('smsSelectAllOrders').checked;
      let orders = sms_getOrders();
      orders.forEach(o => o.selected = checked);
      sms_saveOrders(orders);
      sms_renderSendOrdersList();
    }

    function sms_applyTemplateToSelected() {
      const templateId = document.getElementById('smsTemplateSelect').value;
      if (!templateId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç¯„æœ¬');
        return;
      }

      const templates = sms_getTemplates();
      const template = templates.find(t => t.id == templateId);
      if (!template) return;

      const customContent = document.getElementById('smsTemplatePreview').value.trim();
      const contentToApply = customContent || template.content;

      let orders = sms_getOrders();
      let appliedCount = 0;
      orders.forEach(o => {
        if (o.selected) {
          o.smsContent = contentToApply
            .replace('{customerName}', o.customerName)
            .replace('{orderNumber}', o.orderNumber || '-')
            .replace('{storeType}', o.storeType)
            .replace('{storeName}', o.storeName || '-')
            .replace('{pickupDeadline}', o.pickupDeadline || '-');
          appliedCount++;
        }
      });
      sms_saveOrders(orders);
      sms_renderSendOrdersList();
      alert(`å·²å°‡ç¯„æœ¬å¥—ç”¨åˆ° ${appliedCount} å€‹é¸å–çš„å®¢æˆ¶`);
    }

    function sms_saveDrafts() {
      alert('è‰ç¨¿å·²å„²å­˜ï¼');
    }

    function sms_startSending() {
      const orders = sms_getOrders();
      const selectedOrders = orders.filter(o => o.selected && o.smsContent);
      if (selectedOrders.length === 0) {
        alert('è«‹å…ˆé¸å–å®¢æˆ¶ä¸¦å¥—ç”¨ç°¡è¨Šå…§å®¹');
        return;
      }
      if (confirm(`ç¢ºå®šè¦ç™¼é€ç°¡è¨Šçµ¦ ${selectedOrders.length} ä½å®¢æˆ¶å—ï¼Ÿ`)) {
        alert(`å·²ç™¼é€ç°¡è¨Šçµ¦ ${selectedOrders.length} ä½å®¢æˆ¶ï¼`);
      }
    }

    function sms_renderSendOrdersList() {
      const orders = sms_getOrders();
      const list = document.getElementById('smsSendOrdersList');
      list.innerHTML = '';

      if (orders.length === 0) {
        list.innerHTML = '<div class="sms-empty-state">å°šç„¡è¨‚å–®è³‡æ–™ï¼Œè«‹æ–°å¢æˆ–åŒ¯å…¥è¨‚å–®ã€‚</div>';
        return;
      }

      orders.forEach(o => {
        const card = document.createElement('div');
        card.className = `sms-order-card ${o.selected ? 'selected' : ''} ${o.smsContent ? 'expanded' : ''}`;
        card.innerHTML = `
          <div class="sms-send-row">
            <div class="sms-send-left">
              <input type="checkbox" ${o.selected ? 'checked' : ''} onchange="sms_toggleOrderSelection(${o.id})">
            </div>
            <div class="sms-send-summary" onclick="sms_toggleCardExpand(${o.id})">
              <div class="sms-send-summary-top">
