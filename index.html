<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS å®¢æˆ¶ç®¡ç†ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .sync-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }

    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 2s infinite;
    }

    .sync-indicator.offline {
      background: #f87171;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
    }

    .tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #6c757d;
      transition: all 0.3s;
      border: none;
      background: none;
      font-size: 16px;
    }

    .tab.active {
      color: #667eea;
      background: white;
      border-bottom: 3px solid #667eea;
    }

    .tab-content {
      display: none;
      padding: 30px;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #000;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .order-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }

    .order-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .order-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .order-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: #212529;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .template-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .template-name {
      font-size: 18px;
      font-weight: 600;
      color: #212529;
    }

    .template-content {
      color: #495057;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-draft {
      background: #fff3cd;
      color: #856404;
    }

    .badge-sent {
      background: #d4edda;
      color: #155724;
    }

    .sms-preview {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
      border-left: 4px solid #667eea;
    }

    .sms-preview-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .sms-preview-content {
      color: #212529;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #212529;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .alert.show {
      display: block;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .reset-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      z-index: 999;
    }

    @media (max-width: 768px) {
      .container {
        border-radius: 0;
      }

      .header h1 {
        font-size: 24px;
      }

      .tab {
        padding: 15px 10px;
        font-size: 14px;
      }

      .tab-content {
        padding: 20px;
      }

      .order-info {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <button class="reset-btn" onclick="resetTemplates()">ğŸ”„ é‡ç½®ç¯„æœ¬</button>

  <div class="container">
    <div class="header">
      <h1>ğŸ“± SMS å®¢æˆ¶ç®¡ç†ç³»çµ±</h1>
      <div class="sync-status">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">é›²ç«¯åŒæ­¥ä¸­...</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
      <button class="tab" onclick="switchTab('templates')">ğŸ’¬ ç°¡è¨Šç¯„æœ¬</button>
      <button class="tab" onclick="switchTab('send')">ğŸ“¤ ç™¼é€ç°¡è¨Š</button>
    </div>

    <div id="ordersTab" class="tab-content active">
      <div class="button-group">
        <button class="btn btn-primary" onclick="showAddOrderModal()">â• æ–°å¢å–®ç­†è¨‚å–®</button>
        <button class="btn btn-secondary" onclick="showBulkImportModal()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥</button>
        <button class="btn btn-success" onclick="exportOrders()">ğŸ’¾ åŒ¯å‡ºè¨‚å–®</button>
        <button class="btn btn-danger" onclick="clearAllOrders()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
      </div>

      <div id="ordersList"></div>
    </div>

    <div id="templatesTab" class="tab-content">
      <div class="button-group">
        <button class="btn btn-primary" onclick="showAddTemplateModal()">â• æ–°å¢ç¯„æœ¬</button>
        <button class="btn btn-success" onclick="exportTemplates()">ğŸ’¾ åŒ¯å‡ºç¯„æœ¬</button>
        <button class="btn btn-secondary" onclick="importTemplates()">ğŸ“¥ åŒ¯å…¥ç¯„æœ¬</button>
      </div>

      <div id="templatesList"></div>
    </div>

    <div id="sendTab" class="tab-content">
      <div class="form-group">
        <label>
          <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll()">
          å…¨é¸æ‰€æœ‰è¨‚å–®
        </label>
      </div>

      <div class="form-group">
        <label>é¸æ“‡ç°¡è¨Šç¯„æœ¬</label>
        <select id="templateSelect" onchange="previewTemplate()">
          <option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>
        </select>
      </div>

      <div class="form-group">
        <label>ç¯„æœ¬å…§å®¹ï¼ˆå¯ç·¨è¼¯ï¼‰</label>
        <textarea id="templatePreview" placeholder="é¸æ“‡ç¯„æœ¬å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="applyTemplateToSelected()">âœ… å¥—ç”¨åˆ°é¸å–çš„å®¢æˆ¶</button>
        <button class="btn btn-warning" onclick="saveDrafts()">ğŸ’¾ å„²å­˜è‰ç¨¿</button>
        <button class="btn btn-success" onclick="startSending()">ğŸ“¤ é–‹å§‹ç™¼é€ç°¡è¨Š</button>
      </div>

      <div id="sendOrdersList"></div>
    </div>
  </div>

  <!-- æ–°å¢è¨‚å–® Modal -->
  <div id="addOrderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">æ–°å¢è¨‚å–®</div>
      <div class="form-group">
        <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
        <input type="tel" id="orderPhone" placeholder="0912345678">
      </div>
      <div class="form-group">
        <label>å®¢æˆ¶å§“å *</label>
        <input type="text" id="orderName" placeholder="ç‹å°æ˜">
      </div>
      <div class="form-group">
        <label>è¨‚å–®è™Ÿç¢¼</label>
        <input type="text" id="orderNumber" placeholder="A12345">
      </div>
      <div class="form-group">
        <label>é–€å¸‚é¡åˆ¥</label>
        <select id="orderStoreType">
          <option value="å…¨å®¶">å…¨å®¶</option>
          <option value="7-11">7-11</option>
          <option value="èŠçˆ¾å¯Œ">èŠçˆ¾å¯Œ</option>
          <option value="OKè¶…å•†">OKè¶…å•†</option>
        </select>
      </div>
      <div class="form-group">
        <label>é–€å¸‚åç¨±</label>
        <input type="text" id="orderStoreName" placeholder="å°åŒ—è»Šç«™åº—">
      </div>
      <div class="form-group">
        <label>å–è²¨æœŸé™</label>
        <input type="date" id="orderDeadline">
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="addOrder()">âœ… ç¢ºèªæ–°å¢</button>
        <button class="btn btn-secondary" onclick="closeModal('addOrderModal')">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡åŒ¯å…¥ Modal -->
  <div id="bulkImportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">æ‰¹é‡åŒ¯å…¥è¨‚å–®</div>
      <div class="alert alert-info show">
        è«‹è²¼ä¸Š Excel è³‡æ–™ï¼Œæ ¼å¼ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ã€å§“åã€è¨‚å–®è™Ÿç¢¼ã€é–€å¸‚é¡åˆ¥ã€é–€å¸‚åç¨±ã€å–è²¨æœŸé™ï¼ˆç”¨ Tab æˆ–é€—è™Ÿåˆ†éš”ï¼‰
      </div>
      <div class="form-group">
        <label>è²¼ä¸Šè³‡æ–™</label>
        <textarea id="bulkImportData" rows="10" placeholder="0912345678	ç‹å°æ˜	A12345	å…¨å®¶	å°åŒ—è»Šç«™åº—	2026/01/20"></textarea>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="bulkImport()">âœ… ç¢ºèªåŒ¯å…¥</button>
        <button class="btn btn-secondary" onclick="closeModal('bulkImportModal')">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ç¯„æœ¬ Modal -->
  <div id="addTemplateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">æ–°å¢ç°¡è¨Šç¯„æœ¬</div>
      <div class="alert alert-info show">
        å¯ç”¨è®Šæ•¸ï¼š{customerName}ã€{orderNumber}ã€{storeType}ã€{storeName}ã€{pickupDeadline}
      </div>
      <div class="form-group">
        <label>ç¯„æœ¬åç¨± *</label>
        <input type="text" id="templateName" placeholder="å–è²¨é€šçŸ¥">
      </div>
      <div class="form-group">
        <label>ç¯„æœ¬å…§å®¹ *</label>
        <textarea id="templateContent" placeholder="è¦ªæ„›çš„{customerName}æ‚¨å¥½ï¼Œæ‚¨çš„è¨‚å–®{orderNumber}å·²é€é”{storeType}{storeName}ï¼Œè«‹æ–¼{pickupDeadline}å‰å–è²¨ã€‚"></textarea>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="addTemplate()">âœ… ç¢ºèªæ–°å¢</button>
        <button class="btn btn-secondary" onclick="closeModal('addTemplateModal')">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯ç°¡è¨Š Modal -->
  <div id="editSmsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ç·¨è¼¯ç°¡è¨Šå…§å®¹</div>
      <div class="form-group">
        <label>å®¢æˆ¶ï¼š<span id="editSmsCustomer"></span></label>
      </div>
      <div class="form-group">
        <label>ç°¡è¨Šå…§å®¹</label>
        <textarea id="editSmsContent" rows="6"></textarea>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="saveEditedSms()">âœ… å„²å­˜</button>
        <button class="btn btn-secondary" onclick="closeModal('editSmsModal')">âŒ å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase åˆå§‹åŒ–
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDcKclyNssDs08E0DIwfrc7lzq3QQL4QS8",
      authDomain: "sms-miris.firebaseapp.com",
      databaseURL: "https://sms-miris-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sms-miris",
      storageBucket: "sms-miris.firebasestorage.app",
      messagingSenderId: "340097404227",
      appId: "1:340097404227:web:554901219608cbed42f3f6"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ç¾è‰çš„å®¶å°ˆç”¨ç¯„æœ¬
   const defaultTemplates = [
  {
    name: "åˆ°è²¨é€šçŸ¥(å·²ä»˜æ¬¾)",
    content: "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚:{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰æ”œå¸¶è­‰ä»¶å–è²¨ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"
  },
  {
    name: "ç¬¬ä¸€å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
    content: "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"
  },
  {
    name: "ç¬¬3å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
    content: "ã€å–ä»¶å‰©é¤˜4æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†3æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
  },
  {
    name: "ç¬¬5å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
    content: "ã€å–ä»¶å‰©é¤˜2æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†5æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
  },
  {
    name: "ç¬¬6å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
    content: "ã€å–ä»¶æœ€å¾Œ1æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†6æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
  }
];


    // å…¨åŸŸè®Šæ•¸
    window.orders = [];
    window.templates = [];
    window.selectedOrders = new Set();
    window.smsContent = {};
    window.currentEditingPhone = null;

    // æ ¼å¼åŒ–æ—¥æœŸç‚º MM/DD
    function formatDateToMMDD(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${month}/${day}`;
    }

    // åŒæ­¥ç‹€æ…‹
    let isOnline = navigator.onLine;
    updateSyncStatus();

    window.addEventListener('online', () => {
      isOnline = true;
      updateSyncStatus();
      syncToCloud();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateSyncStatus();
    });

    function updateSyncStatus() {
      const indicator = document.getElementById('syncIndicator');
      const status = document.getElementById('syncStatus');
      
      if (isOnline) {
        indicator.classList.remove('offline');
        status.textContent = 'å·²é€£ç·š - å³æ™‚åŒæ­¥';
      } else {
        indicator.classList.add('offline');
        status.textContent = 'é›¢ç·šæ¨¡å¼';
      }
    }

    // é‡ç½®ç¯„æœ¬ï¼ˆå¼·åˆ¶ï¼‰
    window.resetTemplates = async function() {
      if (confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ç¯„æœ¬å—ï¼Ÿé€™æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰ç¯„æœ¬ï¼')) {
        window.templates = defaultTemplates;
        await syncToCloud();
        renderTemplates();
        updateTemplateSelect();
        alert('âœ… ç¯„æœ¬å·²é‡ç½®ï¼');
      }
    };

    // å¾ Firebase è¼‰å…¥è³‡æ–™
    async function loadFromCloud() {
      const ordersRef = ref(database, 'orders');
      const templatesRef = ref(database, 'templates');

      onValue(ordersRef, (snapshot) => {
        const data = snapshot.val();
        if (data && Array.isArray(data)) {
          window.orders = data;
        } else {
          window.orders = [];
        }
        renderOrders();
        renderSendOrders();
      });

      // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰ç¯„æœ¬
      const templatesSnapshot = await get(templatesRef);
      if (!templatesSnapshot.exists() || !templatesSnapshot.val() || templatesSnapshot.val().length === 0) {
        console.log('ğŸ”§ åˆå§‹åŒ–é è¨­ç¯„æœ¬...');
        window.templates = defaultTemplates;
        await syncToCloud();
      }

      onValue(templatesRef, (snapshot) => {
        const data = snapshot.val();
        if (data && Array.isArray(data) && data.length > 0) {
          window.templates = data;
        }
        renderTemplates();
        updateTemplateSelect();
      });
    }

    // åŒæ­¥åˆ° Firebase
    async function syncToCloud() {
      if (!isOnline) return;

      try {
        await set(ref(database, 'orders'), window.orders);
        await set(ref(database, 'templates'), window.templates);
        console.log('âœ… è³‡æ–™å·²åŒæ­¥åˆ°é›²ç«¯');
      } catch (error) {
        console.error('âŒ åŒæ­¥å¤±æ•—:', error);
      }
    }

    window.syncToCloud = syncToCloud;

    // åˆå§‹åŒ–
    loadFromCloud();

    // åˆ‡æ›åˆ†é 
    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    };

    // é¡¯ç¤º/é—œé–‰ Modal
    window.showAddOrderModal = function() {
      document.getElementById('addOrderModal').classList.add('active');
    };

    window.showBulkImportModal = function() {
      document.getElementById('bulkImportModal').classList.add('active');
    };

    window.showAddTemplateModal = function() {
      document.getElementById('addTemplateModal').classList.add('active');
    };

    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    };

    // æ–°å¢è¨‚å–®
    window.addOrder = function() {
      const phone = document.getElementById('orderPhone').value.trim();
      const name = document.getElementById('orderName').value.trim();
      
      if (!phone || !name) {
        alert('è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼å’Œå§“å');
        return;
      }

      const order = {
        phone,
        customerName: name,
        orderNumber: document.getElementById('orderNumber').value.trim(),
        storeType: document.getElementById('orderStoreType').value,
        storeName: document.getElementById('orderStoreName').value.trim(),
        pickupDeadline: document.getElementById('orderDeadline').value
      };

      window.orders.push(order);
      syncToCloud();
      renderOrders();
      renderSendOrders();
      closeModal('addOrderModal');
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('orderPhone').value = '';
      document.getElementById('orderName').value = '';
      document.getElementById('orderNumber').value = '';
      document.getElementById('orderStoreName').value = '';
      document.getElementById('orderDeadline').value = '';
    };

    // æ‰¹é‡åŒ¯å…¥
    window.bulkImport = function() {
      const data = document.getElementById('bulkImportData').value.trim();
      if (!data) {
        alert('è«‹è²¼ä¸Šè³‡æ–™');
        return;
      }

      const lines = data.split('\n');
      let imported = 0;

      lines.forEach(line => {
        const parts = line.split(/[\t,]/).map(p => p.trim());
        if (parts.length >= 2) {
          window.orders.push({
            phone: parts[0],
            customerName: parts[1],
            orderNumber: parts[2] || '',
            storeType: parts[3] || 'å…¨å®¶',
            storeName: parts[4] || '',
            pickupDeadline: parts[5] || ''
          });
          imported++;
        }
      });

      syncToCloud();
      renderOrders();
      renderSendOrders();
      closeModal('bulkImportModal');
      document.getElementById('bulkImportData').value = '';
      alert(`æˆåŠŸåŒ¯å…¥ ${imported} ç­†è¨‚å–®`);
    };

    // åˆªé™¤è¨‚å–®
    window.deleteOrder = function(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
        window.orders.splice(index, 1);
        syncToCloud();
        renderOrders();
        renderSendOrders();
      }
    };

    // æ¸…ç©ºæ‰€æœ‰è¨‚å–®
    window.clearAllOrders = function() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        window.orders = [];
        window.selectedOrders.clear();
        window.smsContent = {};
        syncToCloud();
        renderOrders();
        renderSendOrders();
      }
    };

    // åŒ¯å‡ºè¨‚å–®
    window.exportOrders = function() {
      const dataStr = JSON.stringify(window.orders, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `è¨‚å–®è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    // æ¸²æŸ“è¨‚å–®åˆ—è¡¨
    function renderOrders() {
      const container = document.getElementById('ordersList');
      
      if (window.orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <p>å°šç„¡è¨‚å–®è³‡æ–™</p>
            <p style="font-size: 14px; margin-top: 10px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢è¨‚å–®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.orders.map((order, index) => `
        <div class="order-card">
          <div class="order-header">
            <div style="font-size: 18px; font-weight: 600;">
              ${order.customerName}
              ${window.smsContent[order.phone] ? '<span class="badge badge-draft">è‰ç¨¿</span>' : ''}
            </div>
            <button class="btn btn-danger btn-small" onclick="deleteOrder(${index})">åˆªé™¤</button>
          </div>
          <div class="order-info">
            <div class="info-item">
              <div class="info-label">æ‰‹æ©Ÿè™Ÿç¢¼</div>
              <div class="info-value">${order.phone}</div>
            </div>
            <div class="info-item">
              <div class="info-label">è¨‚å–®è™Ÿç¢¼</div>
              <div class="info-value">${order.orderNumber || '-'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å–è²¨é–€å¸‚</div>
              <div class="info-value">${order.storeType} ${order.storeName || ''}</div>
            </div>
            <div class="info-item">
              <div class="info-label">å–è²¨æœŸé™</div>
              <div class="info-value">${formatDateToMMDD(order.pickupDeadline) || '-'}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æ–°å¢ç¯„æœ¬
    window.addTemplate = function() {
      const name = document.getElementById('templateName').value.trim();
      const content = document.getElementById('templateContent').value.trim();
      
      if (!name || !content) {
        alert('è«‹å¡«å¯«ç¯„æœ¬åç¨±å’Œå…§å®¹');
        return;
      }

      window.templates.push({ name, content });
      syncToCloud();
      renderTemplates();
      updateTemplateSelect();
      closeModal('addTemplateModal');
      
      document.getElementById('templateName').value = '';
      document.getElementById('templateContent').value = '';
    };

    // åˆªé™¤ç¯„æœ¬
    window.deleteTemplate = function(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯„æœ¬å—ï¼Ÿ')) {
        window.templates.splice(index, 1);
        syncToCloud();
        renderTemplates();
        updateTemplateSelect();
      }
    };

    // åŒ¯å‡ºç¯„æœ¬
    window.exportTemplates = function() {
      const dataStr = JSON.stringify(window.templates, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ç°¡è¨Šç¯„æœ¬_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    // åŒ¯å…¥ç¯„æœ¬
    window.importTemplates = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            window.templates = imported;
            syncToCloud();
            renderTemplates();
            updateTemplateSelect();
            alert('ç¯„æœ¬åŒ¯å…¥æˆåŠŸï¼');
          } catch (error) {
            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // æ¸²æŸ“ç¯„æœ¬åˆ—è¡¨
    function renderTemplates() {
      const container = document.getElementById('templatesList');
      
      if (window.templates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <p>å°šç„¡ç°¡è¨Šç¯„æœ¬</p>
            <p style="font-size: 14px; margin-top: 10px;">é»æ“Šå³ä¸‹è§’ã€ŒğŸ”„ é‡ç½®ç¯„æœ¬ã€è¼‰å…¥é è¨­ç¯„æœ¬</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.templates.map((template, index) => `
        <div class="template-card">
          <div class="template-header">
            <div class="template-name">${template.name}</div>
            <button class="btn btn-danger btn-small" onclick="deleteTemplate(${index})">åˆªé™¤</button>
          </div>
          <div class="template-content">${template.content}</div>
        </div>
      `).join('');
    }

    // æ›´æ–°ç¯„æœ¬é¸å–®
    function updateTemplateSelect() {
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>' +
        window.templates.map((t, i) => `<option value="${i}">${t.name}</option>`).join('');
    }

    // é è¦½ç¯„æœ¬
    window.previewTemplate = function() {
      const select = document.getElementById('templateSelect');
      const preview = document.getElementById('templatePreview');
      
      if (select.value === '') {
        preview.value = '';
        return;
      }

      const template = window.templates[select.value];
      preview.value = template.content;
    };

    // å¥—ç”¨ç¯„æœ¬åˆ°é¸å–çš„å®¢æˆ¶
    window.applyTemplateToSelected = function() {
      const content = document.getElementById('templatePreview').value.trim();
      
      if (!content) {
        alert('è«‹é¸æ“‡ç¯„æœ¬æˆ–è¼¸å…¥å…§å®¹');
        return;
      }

      if (window.selectedOrders.size === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ç™¼é€çš„å®¢æˆ¶');
        return;
      }

      window.selectedOrders.forEach(phone => {
        const order = window.orders.find(o => o.phone === phone);
        if (order) {
          window.smsContent[phone] = replacePlaceholders(content, order);
        }
      });

      renderSendOrders();
      renderOrders();
      alert(`å·²å¥—ç”¨ç¯„æœ¬åˆ° ${window.selectedOrders.size} ä½å®¢æˆ¶`);
    };

    // æ›¿æ›ä½”ä½ç¬¦
    function replacePlaceholders(template, order) {
      return template
        .replace(/{customerName}/g, order.customerName)
        .replace(/{orderNumber}/g, order.orderNumber || '')
        .replace(/{storeType}/g, order.storeType)
        .replace(/{storeName}/g, order.storeName || '')
        .replace(/{pickupDeadline}/g, formatDateToMMDD(order.pickupDeadline) || '');
    }

    // å…¨é¸/å–æ¶ˆå…¨é¸
    window.toggleSelectAll = function() {
      const checked = document.getElementById('selectAllOrders').checked;
      
      if (checked) {
        window.orders.forEach(order => window.selectedOrders.add(order.phone));
      } else {
        window.selectedOrders.clear();
      }
      
      renderSendOrders();
    };

    // åˆ‡æ›è¨‚å–®é¸å–ç‹€æ…‹
    window.toggleOrderSelection = function(phone) {
      if (window.selectedOrders.has(phone)) {
        window.selectedOrders.delete(phone);
      } else {
        window.selectedOrders.add(phone);
      }
      renderSendOrders();
    };

    // ç·¨è¼¯ç°¡è¨Š
    window.editSms = function(phone) {
      window.currentEditingPhone = phone;
      const order = window.orders.find(o => o.phone === phone);
      document.getElementById('editSmsCustomer').textContent = order.customerName;
      document.getElementById('editSmsContent').value = window.smsContent[phone] || '';
      document.getElementById('editSmsModal').classList.add('active');
    };

    // å„²å­˜ç·¨è¼¯çš„ç°¡è¨Š
    window.saveEditedSms = function() {
      const content = document.getElementById('editSmsContent').value.trim();
      if (content) {
        window.smsContent[window.currentEditingPhone] = content;
        renderSendOrders();
        renderOrders();
      }
      closeModal('editSmsModal');
    };

    // å„²å­˜è‰ç¨¿
    window.saveDrafts = function() {
      if (Object.keys(window.smsContent).length === 0) {
        alert('æ²’æœ‰è¦å„²å­˜çš„è‰ç¨¿');
        return;
      }
      
      localStorage.setItem('smsDrafts', JSON.stringify(window.smsContent));
      renderOrders();
      alert('è‰ç¨¿å·²å„²å­˜');
    };

    // é–‹å§‹ç™¼é€
    window.startSending = async function() {
      const toSend = window.orders.filter(o => window.smsContent[o.phone]);
      
      if (toSend.length === 0) {
        alert('è«‹å…ˆå¥—ç”¨ç¯„æœ¬åˆ°å®¢æˆ¶');
        return;
      }

      if (!confirm(`ç¢ºå®šè¦ç™¼é€ ${toSend.length} å‰‡ç°¡è¨Šå—ï¼Ÿ`)) {
        return;
      }

      for (let i = 0; i < toSend.length; i++) {
        const order = toSend[i];
        const message = window.smsContent[order.phone];
        const smsUrl = `sms:${order.phone}?body=${encodeURIComponent(message)}`;
        
        window.open(smsUrl, '_blank');
        
        if (i < toSend.length - 1) {
          const shouldContinue = confirm(`å·²é–‹å•Ÿç¬¬ ${i + 1} å‰‡ç°¡è¨Š\n\nç¹¼çºŒç™¼é€ä¸‹ä¸€å‰‡ï¼Ÿ`);
          if (!shouldContinue) break;
        }
      }

      alert('ç™¼é€å®Œæˆï¼');
    };

    // æ¸²æŸ“ç™¼é€åˆ—è¡¨
    function renderSendOrders() {
      const container = document.getElementById('sendOrdersList');
      
      if (window.orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <p>å°šç„¡è¨‚å–®è³‡æ–™</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.orders.map(order => {
        const isSelected = window.selectedOrders.has(order.phone);
        const hasSms = window.smsContent[order.phone];
        
        return `
          <div class="order-card ${isSelected ? 'selected' : ''}">
            <div class="order-header">
              <label class="checkbox-label">
                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                       onchange="toggleOrderSelection('${order.phone}')">
                <span style="font-size: 18px; font-weight: 600;">
                  ${order.customerName} (${order.phone})
                </span>
              </label>
              ${hasSms ? '<button class="btn btn-warning btn-small" onclick="editSms(\'' + order.phone + '\')">ç·¨è¼¯</button>' : ''}
            </div>
            ${hasSms ? `
              <div class="sms-preview">
                <div class="sms-preview-label">ğŸ“± ç°¡è¨Šé è¦½</div>
                <div class="sms-preview-content">${window.smsContent[order.phone]}</div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // åˆå§‹æ¸²æŸ“
    renderOrders();
    renderTemplates();
    updateTemplateSelect();
    renderSendOrders();
  </script>
</body>
</html>
