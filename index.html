<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SMSç°¡è¨Š">
  <title>SMS å®¢æˆ¶ç°¡è¨Šç·¨è¼¯</title>
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234F46E5' width='100' height='100'/><text y='70' font-size='70' text-anchor='middle' x='50' fill='white'>ğŸ“±</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
    }
    .draft-badge {
      background: #FEF3C7;
      color: #92400E;
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <!-- æ¨™é¡Œ -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        SMS å®¢æˆ¶ç°¡è¨Šç·¨è¼¯
      </h1>
      <p class="text-gray-600 mt-2">é¸æ“‡å®¢æˆ¶ â†’ å¥—ç”¨ç¯„æœ¬ â†’ é è¦½ â†’ ç™¼é€</p>
    </div>

    <!-- æ“ä½œæµç¨‹æç¤º -->
    <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-indigo-200 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-indigo-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="flex-1">
          <strong class="text-indigo-900">ä½¿ç”¨æ­¥é©Ÿï¼š</strong>
          <ol class="mt-2 space-y-1 text-sm text-gray-700">
            <li>1ï¸âƒ£ æ‰¹é‡åŒ¯å…¥æˆ–æ–°å¢å®¢æˆ¶è¨‚å–®</li>
            <li>2ï¸âƒ£ å‹¾é¸è¦ç™¼é€ç°¡è¨Šçš„å®¢æˆ¶</li>
            <li>3ï¸âƒ£ åœ¨ä¸‹æ–¹é¸æ“‡ç°¡è¨Šç¯„æœ¬ï¼ˆæœƒè‡ªå‹•å¥—ç”¨å®¢æˆ¶è³‡è¨Šï¼‰</li>
            <li>4ï¸âƒ£ é è¦½æ¯ä½å®¢æˆ¶çš„ç°¡è¨Šå…§å®¹</li>
            <li>5ï¸âƒ£ é»æ“Šã€Œç™¼é€ã€æˆ–ã€Œå„²å­˜è‰ç¨¿ã€</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- è¨‚å–®ç®¡ç†å€ -->
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="border-b p-6">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h2 class="text-xl font-bold flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              å®¢æˆ¶è¨‚å–®åˆ—è¡¨
              <span class="text-sm font-normal text-gray-500" id="orderCount">(0 ç­†)</span>
              <span class="text-sm font-normal text-indigo-600" id="selectedCount"></span>
            </h2>
            <p class="text-gray-600 text-sm mt-1">å‹¾é¸è¦ç™¼é€ç°¡è¨Šçš„å®¢æˆ¶</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button onclick="selectAllOrders()" class="px-4 py-2 border border-indigo-300 text-indigo-600 rounded-md hover:bg-indigo-50 flex items-center gap-2 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              å…¨é¸
            </button>
            <button onclick="deselectAllOrders()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-2 text-sm">
              å–æ¶ˆå…¨é¸
            </button>
            <button onclick="showImportDialog()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              æ‰¹é‡åŒ¯å…¥
            </button>
            <button onclick="addSingleOrder()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-2 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              æ–°å¢å–®ç­†
            </button>
            <button onclick="clearAllOrders()" class="px-4 py-2 border border-red-300 text-red-600 rounded-md hover:bg-red-50 flex items-center gap-2 text-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              æ¸…ç©ºåˆ—è¡¨
            </button>
          </div>
        </div>
      </div>
      
      <!-- è¨‚å–®åˆ—è¡¨ -->
      <div class="p-6">
        <div id="orderListEmpty" class="text-center py-12 text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="text-lg font-medium">å°šç„¡è¨‚å–®è³‡æ–™</p>
          <p class="text-sm mt-2">é»æ“Šã€Œæ‰¹é‡åŒ¯å…¥ã€æˆ–ã€Œæ–°å¢å–®ç­†ã€é–‹å§‹</p>
        </div>
        
        <div id="orderListContainer" class="hidden space-y-3"></div>
      </div>
    </div>

    <!-- ç°¡è¨Šç¯„æœ¬é¸æ“‡å€ -->
    <div id="templateSection" class="hidden bg-white rounded-lg shadow-md mb-6">
      <div class="border-b p-6">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
          </svg>
          é¸æ“‡ç°¡è¨Šç¯„æœ¬
        </h2>
        <p class="text-gray-600 text-sm mt-1">é¸æ“‡ç¯„æœ¬å¾Œæœƒè‡ªå‹•å¥—ç”¨åˆ°å·²å‹¾é¸çš„å®¢æˆ¶</p>
      </div>
      <div class="p-6 space-y-4">
        <!-- ç¯„æœ¬ç®¡ç† -->
        <div>
          <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
            <label class="block text-sm font-medium">å¿«é€Ÿç¯„æœ¬</label>
            <div class="flex gap-2 flex-wrap">
              <button onclick="openTemplateDialog()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                æ–°å¢ç¯„æœ¬
              </button>
            </div>
          </div>
          <select id="templateSelect" onchange="applyTemplate()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">é¸æ“‡ç¯„æœ¬...</option>
          </select>
        </div>

        <!-- è‡ªè¨‚ç¯„æœ¬åˆ—è¡¨ -->
        <div id="customTemplatesList" class="hidden">
          <label class="block text-sm font-medium mb-2">æˆ‘çš„è‡ªè¨‚ç¯„æœ¬</label>
          <div id="customTemplatesContainer" class="space-y-2"></div>
        </div>

        <!-- æ‰‹å‹•ç·¨è¼¯ -->
        <div>
          <label class="block text-sm font-medium mb-2">æˆ–æ‰‹å‹•ç·¨è¼¯ç¯„æœ¬</label>
          <div class="flex flex-wrap gap-2 mb-2">
            <button onclick="insertVariable('{customerName}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ å§“å</button>
            <button onclick="insertVariable('{orderNumber}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ è¨‚å–®è™Ÿ</button>
            <button onclick="insertVariable('{storeName}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ é–€å¸‚åç¨±</button>
            <button onclick="insertVariable('{pickupDeadline}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ å–è²¨æœŸé™</button>
          </div>
          <textarea id="message" rows="6" placeholder="è¼¸å…¥ç°¡è¨Šå…§å®¹ï¼Œä½¿ç”¨ {customerName}ã€{orderNumber}ã€{storeName}ã€{pickupDeadline} ä½œç‚ºè®Šæ•¸..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="updateManualTemplate()"></textarea>
          <p class="text-sm text-gray-500 mt-2">
            å­—æ•¸ï¼š<span id="charCount">0</span>/160
            <span id="overLimit" class="text-red-500 ml-2 hidden">âš ï¸ è¶…éå­—æ•¸é™åˆ¶ï¼</span>
          </p>
        </div>

        <div class="flex gap-3">
          <button onclick="applyManualTemplate()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            å¥—ç”¨åˆ°é¸å–çš„å®¢æˆ¶
          </button>
        </div>
      </div>
    </div>

    <!-- é è¦½å€ -->
    <div id="previewSection" class="hidden bg-white rounded-lg shadow-md mb-6">
      <div class="border-b p-6">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
          ç°¡è¨Šé è¦½
          <span class="text-sm font-normal text-gray-500" id="previewCount"></span>
        </h2>
        <p class="text-gray-600 text-sm mt-1">ç¢ºèªæ¯ä½å®¢æˆ¶çš„ç°¡è¨Šå…§å®¹</p>
      </div>
      <div class="p-6">
        <div id="previewContainer" class="space-y-4"></div>
      </div>
      <div class="border-t p-6 flex gap-3 flex-wrap">
        <button onclick="saveDrafts()" class="px-6 py-3 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
          </svg>
          å„²å­˜è‰ç¨¿
        </button>
        <button onclick="sendAllSMS()" class="px-6 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center gap-2 font-medium">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          é–‹å§‹ç™¼é€ç°¡è¨Š
        </button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡åŒ¯å…¥å°è©±æ¡† -->
  <div id="importDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">æ‰¹é‡åŒ¯å…¥è¨‚å–®</h3>
          <button onclick="closeImportDialog()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm font-medium mb-2">ğŸ“‹ è³‡æ–™æ ¼å¼èªªæ˜ï¼š</p>
          <p class="text-sm text-gray-700 mb-2">è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è²¼ä¸Šè³‡æ–™ï¼ˆæ¯è¡Œä¸€ç­†è¨‚å–®ï¼Œç”¨ Tab æˆ–é€—è™Ÿåˆ†éš”ï¼‰ï¼š</p>
          <code class="text-xs bg-white px-2 py-1 rounded block">æ‰‹æ©Ÿè™Ÿç¢¼, å§“å, è¨‚å–®è™Ÿç¢¼, é–€å¸‚é¡åˆ¥, é–€å¸‚åç¨±, æœˆ, æ—¥</code>
          <p class="text-xs text-gray-600 mt-2">ç¯„ä¾‹ï¼š0912345678, ç‹å°æ˜, ORD001, 7-11, ä¿¡ç¾©é–€å¸‚, 1, 20</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">æ–¹å¼ä¸€ï¼šè²¼ä¸Šè³‡æ–™</label>
          <textarea id="importData" rows="10" placeholder="å¾ Excel è¤‡è£½å¾Œè²¼ä¸Šï¼Œæˆ–æ‰‹å‹•è¼¸å…¥..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">æ–¹å¼äºŒï¼šä¸Šå‚³ CSV æª”æ¡ˆ</label>
          <input type="file" id="importCsvFile" accept=".csv,.txt" onchange="handleCsvUpload(event)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
        </div>

        <div id="importPreview" class="hidden">
          <label class="block text-sm font-medium mb-2">é è¦½ï¼ˆå°‡åŒ¯å…¥ <span id="importCount">0</span> ç­†ï¼‰</label>
          <div class="border rounded-lg overflow-auto max-h-60">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">æ‰‹æ©Ÿ</th>
                  <th class="px-3 py-2 text-left">å§“å</th>
                  <th class="px-3 py-2 text-left">è¨‚å–®è™Ÿ</th>
                  <th class="px-3 py-2 text-left">é–€å¸‚é¡åˆ¥</th>
                  <th class="px-3 py-2 text-left">é–€å¸‚åç¨±</th>
                  <th class="px-3 py-2 text-left">å–è²¨æœŸé™</th>
                </tr>
              </thead>
              <tbody id="importPreviewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="p-6 border-t flex justify-between flex-wrap gap-3">
        <button onclick="downloadTemplate()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center gap-2 text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          ä¸‹è¼‰ç¯„æœ¬
        </button>
        <div class="flex gap-3 flex-wrap">
          <button onclick="closeImportDialog()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 text-sm">å–æ¶ˆ</button>
          <button onclick="previewImport()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">é è¦½è³‡æ–™</button>
          <button onclick="confirmImport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">ç¢ºèªåŒ¯å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å–®ç­†æ–°å¢å°è©±æ¡† -->
  <div id="singleOrderDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b">
        <h3 class="text-xl font-bold">æ–°å¢è¨‚å–®</h3>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
            <input type="tel" id="singlePhone" placeholder="0912345678" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å®¢æˆ¶å§“å *</label>
            <input type="text" id="singleName" placeholder="ç‹å°æ˜" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">è¨‚å–®è™Ÿç¢¼ *</label>
            <input type="text" id="singleOrder" placeholder="ORD001" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">é–€å¸‚é¡åˆ¥ *</label>
            <select id="singleStoreType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">è«‹é¸æ“‡</option>
              <option value="7-11">7-11</option>
              <option value="å…¨å®¶">å…¨å®¶</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">é–€å¸‚åç¨± *</label>
            <input type="text" id="singleStoreName" placeholder="ä¿¡ç¾©é–€å¸‚" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å–è²¨æœŸé™ *</label>
            <div class="flex gap-2">
              <select id="singleMonth" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                <option value="">æœˆ</option>
                <option value="01">1æœˆ</option>
                <option value="02">2æœˆ</option>
                <option value="03">3æœˆ</option>
                <option value="04">4æœˆ</option>
                <option value="05">5æœˆ</option>
                <option value="06">6æœˆ</option>
                <option value="07">7æœˆ</option>
                <option value="08">8æœˆ</option>
                <option value="09">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
              <select id="singleDay" class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                <option value="">æ—¥</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeSingleOrderDialog()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">å–æ¶ˆ</button>
        <button onclick="confirmSingleOrder()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- ç¯„æœ¬å°è©±æ¡† -->
  <div id="templateDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold" id="dialogTitle">æ–°å¢ç¯„æœ¬</h3>
          <button onclick="closeTemplateDialog()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <p class="text-sm text-gray-600 mt-1">å»ºç«‹æ‚¨çš„è‡ªè¨‚ç°¡è¨Šç¯„æœ¬ï¼Œå¯ä½¿ç”¨è®Šæ•¸ï¼š{customerName}, {orderNumber}, {storeName}, {pickupDeadline}</p>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">ç¯„æœ¬åç¨±</label>
          <input type="text" id="newTemplateName" placeholder="ä¾‹å¦‚ï¼šé€±æœ«ä¿ƒéŠ·é€šçŸ¥" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ç¯„æœ¬å…§å®¹</label>
          <textarea id="newTemplateContent" rows="6" placeholder="è¼¸å…¥ç¯„æœ¬å…§å®¹..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <div class="flex flex-wrap gap-2">
          <button onclick="insertTemplateVariable('{customerName}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ å§“å</button>
          <button onclick="insertTemplateVariable('{orderNumber}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ è¨‚å–®è™Ÿ</button>
          <button onclick="insertTemplateVariable('{storeName}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ é–€å¸‚åç¨±</button>
          <button onclick="insertTemplateVariable('{pickupDeadline}')" class="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50">+ å–è²¨æœŸé™</button>
        </div>
      </div>
      <div class="p-6 border-t flex justify-end gap-3">
        <button onclick="closeTemplateDialog()" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">å–æ¶ˆ</button>
        <button onclick="saveTemplate()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">å„²å­˜ç¯„æœ¬</button>
      </div>
    </div>
  </div>

  <script>
    const preloadedTemplates = [
      {"name": "åˆ°è²¨é€šçŸ¥(å·²ä»˜æ¬¾)", "content": "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚:{storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰æ”œå¸¶è­‰ä»¶å–è²¨ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"},
      {"name": "ç¬¬ä¸€å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)", "content": "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚ï¼š{storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"},
      {"name": "ç¬¬3å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)", "content": "ã€å–ä»¶å‰©é¤˜4æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†3æ—¥ï¼ˆé–€å¸‚ï¼š{storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"},
      {"name": "ç¬¬5å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)", "content": "ã€å–ä»¶å‰©é¤˜2æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†5æ—¥ï¼ˆé–€å¸‚ï¼š{storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"},
      {"name": "ç¬¬6å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)", "content": "ã€å–ä»¶æœ€å¾Œ1æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†6æ—¥ï¼ˆé–€å¸‚ï¼š{storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"}
    ];

    let customTemplates = [];
    try {
      const stored = localStorage.getItem('customTemplates');
      if (stored) {
        customTemplates = JSON.parse(stored);
      } else {
        customTemplates = preloadedTemplates;
        localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
      }
    } catch (error) {
      customTemplates = preloadedTemplates;
      localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
    }
    
    let editingTemplateId = null;
    let orders = [];
    try {
      const storedOrders = localStorage.getItem('orders');
      if (storedOrders) orders = JSON.parse(storedOrders);
    } catch (error) {
      orders = [];
    }
    let previewData = [];
    let selectedOrders = new Set();
    let messageDrafts = {};

    document.addEventListener('DOMContentLoaded', function() {
      loadCustomTemplates();
      initializeDayOptions();
      renderOrderList();
    });

    function initializeDayOptions() {
      const select = document.getElementById('singleDay');
      for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i.toString().padStart(2, '0');
        option.textContent = i + 'æ—¥';
        select.appendChild(option);
      }
    }

    function renderOrderList() {
      const container = document.getElementById('orderListContainer');
      const empty = document.getElementById('orderListEmpty');
      const count = document.getElementById('orderCount');
      const selectedCount = document.getElementById('selectedCount');
      
      count.textContent = `(${orders.length} ç­†)`;
      selectedCount.textContent = selectedOrders.size > 0 ? `å·²é¸ ${selectedOrders.size} ç­†` : '';

      if (orders.length === 0) {
        container.classList.add('hidden');
        empty.classList.remove('hidden');
        document.getElementById('templateSection').classList.add('hidden');
        document.getElementById('previewSection').classList.add('hidden');
        return;
      }

      empty.classList.add('hidden');
      container.classList.remove('hidden');
      container.innerHTML = '';

      orders.forEach((order, index) => {
        const isSelected = selectedOrders.has(index);
        const hasDraft = messageDrafts[index];
        
        const div = document.createElement('div');
        div.className = `flex items-center gap-4 p-4 rounded-lg border ${isSelected ? 'bg-indigo-50 border-indigo-300' : 'bg-gray-50 border-gray-200'} hover:shadow-md transition-all`;
        div.innerHTML = `
          <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleOrderSelection(${index})" class="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
          <div class="flex-1 grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
            <div><p class="text-xs text-gray-500">å§“å</p><p class="font-medium">${escapeHtml(order.customerName)}</p></div>
            <div><p class="text-xs text-gray-500">æ‰‹æ©Ÿ</p><p>${escapeHtml(order.phone)}</p></div>
            <div><p class="text-xs text-gray-500">è¨‚å–®è™Ÿ</p><p>${escapeHtml(order.orderNumber)}</p></div>
            <div><p class="text-xs text-gray-500">é–€å¸‚</p><p>${escapeHtml(order.storeType)} ${escapeHtml(order.storeName)}</p></div>
            <div><p class="text-xs text-gray-500">å–è²¨æœŸé™</p><p>${order.pickupMonth}æœˆ${order.pickupDay}æ—¥</p></div>
          </div>
          ${hasDraft ? '<span class="draft-badge">è‰ç¨¿</span>' : ''}
          <button onclick="deleteOrder(${index})" class="p-2 text-red-500 hover:bg-red-50 rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        `;
        container.appendChild(div);
      });

      updateSections();
    }

    function toggleOrderSelection(index) {
      if (selectedOrders.has(index)) {
        selectedOrders.delete(index);
      } else {
        selectedOrders.add(index);
      }
      renderOrderList();
    }

    function selectAllOrders() {
      selectedOrders.clear();
      orders.forEach((_, index) => selectedOrders.add(index));
      renderOrderList();
    }

    function deselectAllOrders() {
      selectedOrders.clear();
      renderOrderList();
    }

    function updateSections() {
      const hasSelection = selectedOrders.size > 0;
      document.getElementById('templateSection').classList.toggle('hidden', !hasSelection);
      
      if (!hasSelection) {
        document.getElementById('previewSection').classList.add('hidden');
      }
    }

    function applyTemplate() {
      const select = document.getElementById('templateSelect');
      const value = select.value;
      if (!value || value === '') return;
      
      const index = parseInt(value.split('_')[1]);
      const template = customTemplates[index];
      document.getElementById('message').value = template.content;
      updateCharCount();
      applyManualTemplate();
    }

    function applyManualTemplate() {
      const template = document.getElementById('message').value.trim();
      if (!template) {
        alert('è«‹å…ˆè¼¸å…¥æˆ–é¸æ“‡ç¯„æœ¬');
        return;
      }

      if (selectedOrders.size === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ç™¼é€çš„å®¢æˆ¶');
        return;
      }

      selectedOrders.forEach(index => {
        const order = orders[index];
        const message = template
          .replace(/{customerName}/g, order.customerName)
          .replace(/{orderNumber}/g, order.orderNumber)
          .replace(/{storeName}/g, `${order.storeType} ${order.storeName}`)
          .replace(/{pickupDeadline}/g, `${parseInt(order.pickupMonth)}æœˆ${parseInt(order.pickupDay)}æ—¥`);
        messageDrafts[index] = message;
      });

      showPreview();
    }

    function showPreview() {
      const previewSection = document.getElementById('previewSection');
      const previewContainer = document.getElementById('previewContainer');
      const previewCount = document.getElementById('previewCount');

      previewCount.textContent = `(${selectedOrders.size} å‰‡ç°¡è¨Š)`;
      previewContainer.innerHTML = '';

      selectedOrders.forEach(index => {
        const order = orders[index];
        const message = messageDrafts[index];

        const div = document.createElement('div');
        div.className = 'border rounded-lg p-4 bg-gray-50';
        div.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div>
              <p class="font-medium text-gray-900">${escapeHtml(order.customerName)}</p>
              <p class="text-sm text-gray-600">${escapeHtml(order.phone)}</p>
            </div>
            <button onclick="editDraft(${index})" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              ç·¨è¼¯
            </button>
          </div>
          <div class="bg-white rounded-lg p-3 border border-gray-200">
            <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(message)}</p>
          </div>
          <p class="text-xs text-gray-500 mt-2">å­—æ•¸ï¼š${message.length} å­—å…ƒ</p>
        `;
        previewContainer.appendChild(div);
      });

      previewSection.classList.remove('hidden');
      previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function editDraft(index) {
      const newMessage = prompt('ç·¨è¼¯ç°¡è¨Šå…§å®¹ï¼š', messageDrafts[index]);
      if (newMessage !== null && newMessage.trim() !== '') {
        messageDrafts[index] = newMessage.trim();
        showPreview();
      }
    }

    function saveDrafts() {
      renderOrderList();
      alert(`å·²å„²å­˜ ${selectedOrders.size} å‰‡ç°¡è¨Šè‰ç¨¿ï¼`);
    }

    function sendAllSMS() {
      if (selectedOrders.size === 0) {
        alert('æ²’æœ‰è¦ç™¼é€çš„ç°¡è¨Š');
        return;
      }

      const confirmed = confirm(`ç¢ºå®šè¦ç™¼é€ ${selectedOrders.size} å‰‡ç°¡è¨Šå—ï¼Ÿ\n\nå°‡æœƒé€ä¸€é–‹å•Ÿç°¡è¨Š App è®“æ‚¨ç¢ºèªç™¼é€ã€‚`);
      if (!confirmed) return;

      const indices = Array.from(selectedOrders);
      let currentIndex = 0;

      function sendNext() {
        if (currentIndex >= indices.length) {
          alert('æ‰€æœ‰ç°¡è¨Šå·²è™•ç†å®Œæˆï¼');
          return;
        }

        const index = indices[currentIndex];
        const order = orders[index];
        const message = messageDrafts[index];
        const cleanPhone = order.phone.replace(/[^0-9+]/g, '');
        const encodedMessage = encodeURIComponent(message);
        
        window.location.href = `sms:${cleanPhone}&body=${encodedMessage}`;
        
        currentIndex++;
        if (currentIndex < indices.length) {
          setTimeout(() => {
            const shouldContinue = confirm(`å·²è™•ç† ${currentIndex}/${indices.length}\n\nç¹¼çºŒç™¼é€ä¸‹ä¸€å‰‡ï¼Ÿ`);
            if (shouldContinue) {
              sendNext();
            }
          }, 1000);
        }
      }

      sendNext();
    }

    function saveOrders() {
      localStorage.setItem('orders', JSON.stringify(orders));
      renderOrderList();
    }

    function deleteOrder(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')) {
        orders.splice(index, 1);
        selectedOrders.delete(index);
        delete messageDrafts[index];
        
        const newSelectedOrders = new Set();
        const newMessageDrafts = {};
        selectedOrders.forEach(oldIndex => {
          const newIndex = oldIndex > index ? oldIndex - 1 : oldIndex;
          newSelectedOrders.add(newIndex);
        });
        Object.keys(messageDrafts).forEach(oldIndex => {
          const idx = parseInt(oldIndex);
          const newIndex = idx > index ? idx - 1 : idx;
          newMessageDrafts[newIndex] = messageDrafts[oldIndex];
        });
        
        selectedOrders = newSelectedOrders;
        messageDrafts = newMessageDrafts;
        saveOrders();
      }
    }

    function clearAllOrders() {
      if (orders.length === 0) {
        alert('è¨‚å–®åˆ—è¡¨å·²ç¶“æ˜¯ç©ºçš„');
        return;
      }
      if (confirm(`ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ ${orders.length} ç­†è¨‚å–®å—ï¼Ÿ`)) {
        orders = [];
        selectedOrders.clear();
        messageDrafts = {};
        saveOrders();
      }
    }

    function showImportDialog() {
      document.getElementById('importDialog').classList.remove('hidden');
      document.getElementById('importData').value = '';
      document.getElementById('importPreview').classList.add('hidden');
      previewData = [];
    }

    function closeImportDialog() {
      document.getElementById('importDialog').classList.add('hidden');
      previewData = [];
    }

    function handleCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('importData').value = e.target.result;
        previewImport();
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function parseImportData(text) {
      const lines = text.trim().split('\n');
      const result = [];
      lines.forEach((line) => {
        if (!line.trim()) return;
        const parts = line.includes('\t') ? line.split('\t') : line.split(',');
        if (parts.length >= 7) {
          result.push({
            phone: parts[0].trim(),
            customerName: parts[1].trim(),
            orderNumber: parts[2].trim(),
            storeType: parts[3].trim(),
            storeName: parts[4].trim(),
            pickupMonth: parts[5].trim().padStart(2, '0'),
            pickupDay: parts[6].trim().padStart(2, '0')
          });
        }
      });
      return result;
    }

    function previewImport() {
      const text = document.getElementById('importData').value;
      if (!text.trim()) {
        alert('è«‹å…ˆè²¼ä¸Šè³‡æ–™');
        return;
      }
      previewData = parseImportData(text);
      if (previewData.length === 0) {
        alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢º');
        return;
      }
      const previewSection = document.getElementById('importPreview');
      const previewBody = document.getElementById('importPreviewBody');
      const importCount = document.getElementById('importCount');
      importCount.textContent = previewData.length;
      previewBody.innerHTML = '';
      previewData.forEach(order => {
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(order.phone)}</td>
          <td class="px-3 py-2">${escapeHtml(order.customerName)}</td>
          <td class="px-3 py-2">${escapeHtml(order.orderNumber)}</td>
          <td class="px-3 py-2">${escapeHtml(order.storeType)}</td>
          <td class="px-3 py-2">${escapeHtml(order.storeName)}</td>
          <td class="px-3 py-2">${order.pickupMonth}æœˆ${order.pickupDay}æ—¥</td>
        `;
        previewBody.appendChild(tr);
      });
      previewSection.classList.remove('hidden');
    }

    function confirmImport() {
      if (previewData.length === 0) {
        alert('è«‹å…ˆé è¦½è³‡æ–™');
        return;
      }
      orders = [...orders, ...previewData];
      saveOrders();
      closeImportDialog();
      alert(`æˆåŠŸåŒ¯å…¥ ${previewData.length} ç­†è¨‚å–®ï¼`);
    }

    function downloadTemplate() {
      const template = 'æ‰‹æ©Ÿè™Ÿç¢¼,å§“å,è¨‚å–®è™Ÿç¢¼,é–€å¸‚é¡åˆ¥,é–€å¸‚åç¨±,æœˆ,æ—¥\n0912345678,ç‹å°æ˜,ORD001,7-11,ä¿¡ç¾©é–€å¸‚,1,20\n0923456789,æå°è¯,ORD002,å…¨å®¶,ä¸­å±±åº—,1,21';
      const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'è¨‚å–®åŒ¯å…¥ç¯„æœ¬.csv';
      link.click();
      URL.revokeObjectURL(url);
    }

    function addSingleOrder() {
      document.getElementById('singleOrderDialog').classList.remove('hidden');
      ['singlePhone', 'singleName', 'singleOrder', 'singleStoreType', 'singleStoreName', 'singleMonth', 'singleDay'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    function closeSingleOrderDialog() {
      document.getElementById('singleOrderDialog').classList.add('hidden');
    }

    function confirmSingleOrder() {
      const order = {
        phone: document.getElementById('singlePhone').value.trim(),
        customerName: document.getElementById('singleName').value.trim(),
        orderNumber: document.getElementById('singleOrder').value.trim(),
        storeType: document.getElementById('singleStoreType').value,
        storeName: document.getElementById('singleStoreName').value.trim(),
        pickupMonth: document.getElementById('singleMonth').value,
        pickupDay: document.getElementById('singleDay').value
      };
      if (!order.phone || !order.customerName || !order.orderNumber || !order.storeType || !order.storeName || !order.pickupMonth || !order.pickupDay) {
        alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
        return;
      }
      orders.push(order);
      saveOrders();
      closeSingleOrderDialog();
      alert('è¨‚å–®æ–°å¢æˆåŠŸï¼');
    }

    function insertVariable(variable) {
      const textarea = document.getElementById('message');
      const cursorPos = textarea.selectionStart;
      textarea.value = textarea.value.substring(0, cursorPos) + variable + textarea.value.substring(cursorPos);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = cursorPos + variable.length;
      updateCharCount();
    }

    function updateManualTemplate() {
      updateCharCount();
    }

    function updateCharCount() {
      const message = document.getElementById('message').value;
      const charCount = document.getElementById('charCount');
      const overLimit = document.getElementById('overLimit');
      charCount.textContent = message.length;
      overLimit.classList.toggle('hidden', message.length <= 160);
    }

    function openTemplateDialog() {
      document.getElementById('templateDialog').classList.remove('hidden');
      document.getElementById('dialogTitle').textContent = 'æ–°å¢ç¯„æœ¬';
      document.getElementById('newTemplateName').value = '';
      document.getElementById('newTemplateContent').value = '';
      editingTemplateId = null;
    }

    function closeTemplateDialog() {
      document.getElementById('templateDialog').classList.add('hidden');
    }

    function insertTemplateVariable(variable) {
      const textarea = document.getElementById('newTemplateContent');
      const cursorPos = textarea.selectionStart;
      textarea.value = textarea.value.substring(0, cursorPos) + variable + textarea.value.substring(cursorPos);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = cursorPos + variable.length;
    }

    function saveTemplate() {
      const name = document.getElementById('newTemplateName').value.trim();
      const content = document.getElementById('newTemplateContent').value.trim();
      if (!name || !content) {
        alert('è«‹å¡«å¯«ç¯„æœ¬åç¨±å’Œå…§å®¹');
        return;
      }
      try {
        if (editingTemplateId !== null) {
          customTemplates[editingTemplateId] = { name, content };
        } else {
          customTemplates.push({ name, content });
        }
        localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
        loadCustomTemplates();
        closeTemplateDialog();
        alert('ç¯„æœ¬å·²å„²å­˜ï¼');
      } catch (error) {
        alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
      }
    }

    function loadCustomTemplates() {
      const container = document.getElementById('customTemplatesContainer');
      const listSection = document.getElementById('customTemplatesList');
      const select = document.getElementById('templateSelect');
      select.innerHTML = '<option value="">é¸æ“‡ç¯„æœ¬...</option>';

      if (customTemplates.length > 0) {
        listSection.classList.remove('hidden');
        container.innerHTML = '';
        customTemplates.forEach((template, index) => {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
          div.innerHTML = `
            <div class="flex-1 min-w-0">
              <p class="font-medium text-sm">${escapeHtml(template.name)}</p>
              <p class="text-xs text-gray-600 mt-1 truncate">${escapeHtml(template.content.substring(0, 50))}...</p>
            </div>
            <div class="flex gap-2 ml-4 flex-shrink-0">
              <button onclick="editTemplate(${index})" class="p-2 hover:bg-gray-200 rounded">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
              </button>
              <button onclick="deleteTemplate(${index})" class="p-2 hover:bg-gray-200 rounded">
                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          `;
          container.appendChild(div);
          const option = document.createElement('option');
          option.value = `custom_${index}`;
          option.textContent = template.name;
          select.appendChild(option);
        });
      } else {
        listSection.classList.add('hidden');
      }
    }

    function editTemplate(index) {
      editingTemplateId = index;
      document.getElementById('dialogTitle').textContent = 'ç·¨è¼¯ç¯„æœ¬';
      document.getElementById('newTemplateName').value = customTemplates[index].name;
      document.getElementById('newTemplateContent').value = customTemplates[index].content;
      document.getElementById('templateDialog').classList.remove('hidden');
    }

    function deleteTemplate(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¯„æœ¬å—ï¼Ÿ')) {
        customTemplates.splice(index, 1);
        localStorage.setItem('customTemplates', JSON.stringify(customTemplates));
        loadCustomTemplates();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
