<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•´åˆç³»çµ±ï¼šæ”¶æ¬¾æ—¥æœŸ + SMSï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆï¼‰</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 16px;
    }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .shell-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 22px 18px;
      text-align: center;
    }
    .shell-header h1 { margin: 0 0 6px 0; font-size: 22px; font-weight: 900; }
    .shell-header p { margin: 0; opacity: 0.92; font-size: 13px; line-height: 1.6; }
    .shell-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
    .shell-tab {
      flex: 1; padding: 14px 10px; border: 0; cursor: pointer;
      font-weight: 900; font-size: 15px; background: transparent; color: #6c757d;
    }
    .shell-tab.active { background: #fff; color: #667eea; border-bottom: 3px solid #667eea; }
    .shell-content { padding: 18px; }
    .shell-panel { display: none; }
    .shell-panel.active { display: block; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      .shell { border-radius: 0; }
      .shell-content { padding: 12px; }
    }

    /* ===== Pay (æ”¶æ¬¾) ===== */
    .pay-tabs { display:flex; background:#f8f9fa; border-bottom:2px solid #e9ecef; border-radius:14px; overflow:hidden; }
    .pay-tab { flex:1; padding:12px 10px; cursor:pointer; border:none; background:#f8f9fa; font-size:15px; font-weight:900; }
    .pay-tab.active { background:#fff; color:#667eea; border-bottom:3px solid #667eea; }
    .pay-panel { display:none; padding:16px 4px; }
    .pay-panel.active { display:block; }

    .pay-form-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 768px) { .pay-form-grid { grid-template-columns: 1fr; } }

    .pay-form-group { margin-bottom:12px; }
    .pay-form-group label { display:block; margin-bottom:8px; font-weight:900; color:#333; }
    .pay-input, .pay-select {
      width:100%; padding:10px 12px; border:2px solid #e9ecef; border-radius:12px; font-size:16px;
    }
    .pay-input:focus, .pay-select:focus { outline:none; border-color:#667eea; }

    .pay-btn { padding:10px 16px; border:0; border-radius:12px; font-weight:900; cursor:pointer; }
    .pay-btn + .pay-btn { margin-left:8px; }
    .pay-btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; }
    .pay-btn-secondary { background:#6c757d; color:#fff; }
    .pay-btn-success { background:#28a745; color:#fff; }
    .pay-btn-danger { background:#dc3545; color:#fff; }
    .pay-btn-warning { background:#ffc107; color:#000; }
    .pay-btn-sm { padding:6px 10px; font-size:12px; border-radius:10px; }

    .pay-result { margin-top:14px; background:#f8f9fa; padding:14px; border-radius:14px; display:none; }
    .pay-result h3 { margin:0 0 10px 0; color:#667eea; }
    .pay-result-row { display:flex; justify-content:space-between; gap:10px; background:#fff; padding:10px 12px; border-radius:12px; margin-bottom:8px; }

    .pay-stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin:12px 0; }
    .pay-stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:14px; border-radius:14px; text-align:center; }
    .pay-stat-card h3 { margin:0 0 6px 0; font-size:28px; }
    .pay-stat-card p { margin:0; opacity:0.95; font-size:12px; }

    .pay-actions { display:flex; gap:10px; flex-wrap:wrap; margin:12px 0; }

    .pay-table-wrap { overflow-x:auto; }
    .pay-table { width:100%; border-collapse:collapse; margin-top:10px; }
    .pay-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; }
    .pay-table th, .pay-table td { padding:10px; border-bottom:1px solid #e9ecef; text-align:left; white-space:nowrap; vertical-align:middle; }
    .pay-checkbox-cell { width:44px; text-align:center; }
    .pay-checkbox-cell input { width:18px; height:18px; cursor:pointer; }
    .pay-status-pending { color:#f0a500; font-weight:900; }
    .pay-status-picked { color:#1e7e34; font-weight:900; }
    .pay-pickup-inline { display:flex; align-items:center; gap:6px; }
    .pay-pickup-inline input[type="date"] { width:140px; padding:6px 8px; border:1px solid #dfe3e6; border-radius:10px; font-size:12px; }

    .pay-upload { border:2px dashed #667eea; padding:22px; text-align:center; border-radius:14px; cursor:pointer; user-select:none; background:#fff; }
    .pay-upload:hover { background:#f8f9fa; }
    .pay-upload input { display:none; }
    .pay-hint { margin-top:14px; background:#f8f9fa; padding:14px; border-radius:14px; color:#444; line-height:1.7; }

    /* ===== SMS ===== */
    .sms-reset-btn {
      position: fixed; bottom: 20px; right: 20px;
      background: #dc3545; color: white;
      padding: 10px 20px; border-radius: 50px; border: none;
      font-weight: 900; cursor: pointer;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      z-index: 999;
      display: none;
    }

    .sms-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .sms-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 22px;
      text-align: center;
    }
    .sms-header h1 { margin: 0 0 8px 0; font-size: 24px; }
    .sms-sync-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 8px;
    }
    .sms-sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      animation: sms_pulse 2s infinite;
    }
    .sms-sync-indicator.offline { background: #f87171; animation: none; }
    @keyframes sms_pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .sms-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
    .sms-tab {
      flex: 1;
      padding: 16px 10px;
      text-align: center;
      cursor: pointer;
      font-weight: 900;
      color: #6c757d;
      border: none;
      background: none;
      font-size: 15px;
    }
    .sms-tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }
    .sms-tab-content { display: none; padding: 18px; }
    .sms-tab-content.active { display: block; animation: sms_fade 0.25s; }
    @keyframes sms_fade { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .sms-form-group { margin-bottom: 16px; }
    .sms-form-group label { display:block; margin-bottom:8px; font-weight:900; color:#495057; }
    .sms-form-group input,
    .sms-form-group select,
    .sms-form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 16px;
    }
    .sms-form-group textarea { min-height: 120px; resize: vertical; }

    .sms-btn {
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      display: inline-block;
    }
    .sms-btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .sms-btn-secondary { background: #6c757d; color: white; }
    .sms-btn-success { background: #28a745; color: white; }
    .sms-btn-danger { background: #dc3545; color: white; }
    .sms-btn-warning { background: #ffc107; color: #000; }
    .sms-btn-small { padding: 8px 12px; font-size: 13px; border-radius: 10px; }
    .sms-button-group { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }

    .sms-order-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 12px;
      border: 2px solid #e9ecef;
      transition: all 0.2s;
    }
    .sms-order-card:hover { border-color:#667eea; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    .sms-order-card.selected { border-color:#667eea; background:#f0f4ff; }
    .sms-order-header { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 12px; }
    .sms-order-info {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .sms-checkbox-label { display:flex; align-items:center; gap:10px; cursor:pointer; }
    .sms-checkbox-label input[type="checkbox"] { width: 20px; height: 20px; cursor:pointer; }

    .sms-template-card {
      background:#f8f9fa;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 12px;
      border: 2px solid #e9ecef;
    }
    .sms-template-header { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 8px; }
    .sms-template-name { font-size: 18px; font-weight: 900; color:#212529; }
    .sms-template-content { color:#495057; line-height:1.6; white-space: pre-wrap; }

    .sms-empty-state { text-align:center; padding: 50px 12px; color:#6c757d; }
    .sms-empty-state-icon { font-size: 56px; margin-bottom: 14px; opacity: 0.5; }

    .sms-badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 900;
      margin-left: 8px;
    }
    .sms-badge-draft { background:#fff3cd; color:#856404; }

    .sms-preview {
      background:#f8f9fa;
      border-radius: 10px;
      padding: 14px;
      margin-top: 10px;
      border-left: 4px solid #667eea;
    }
    .sms-preview-label { font-size: 12px; color:#6c757d; margin-bottom: 8px; font-weight: 900; }
    .sms-preview-content { color:#212529; line-height:1.6; white-space: pre-wrap; }

    .sms-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .sms-modal.active { display:flex; }
    .sms-modal-content {
      background: white;
      border-radius: 18px;
      padding: 20px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .sms-modal-header { font-size: 20px; font-weight: 900; margin-bottom: 14px; color:#212529; }
    .sms-alert {
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* ç™¼é€è¨˜éŒ„ */
    .sms-send-history {
      margin-top: 12px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 10px;
      border-left: 4px solid #3b82f6;
    }
    .sms-send-history-header { font-weight: 900; color: #3b82f6; margin-bottom: 8px; font-size: 14px; }
    .sms-send-history-summary {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: #666;
      flex-wrap: wrap;
      gap: 8px;
    }
    .sms-send-history-summary strong { color: #3b82f6; font-weight: 900; }
    .sms-send-history-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    .sms-history-item { font-size: 12px; color: #666; padding: 4px 8px; background: white; border-radius: 6px; }

    @media (max-width: 768px) {
      .sms-tab-content { padding: 14px; }
      .sms-order-info { grid-template-columns: 1fr; }
      .sms-button-group { flex-direction: column; }
      .sms-btn { width: 100%; }
    }
  </style>
</head>

<body>
  <button class="sms-reset-btn" id="smsResetBtn" onclick="sms_resetTemplates()">ğŸ”„ é‡ç½®ç¯„æœ¬</button>

  <div class="shell">
    <div class="shell-header">
      <h1>æ•´åˆç³»çµ±ï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆï¼‰</h1>
      <p>
        - æ”¶æ¬¾è¨‚å–® Excel æ¬„ä½ï¼šè¨‚å–®è™Ÿ/å§“å/é›»è©±/å¹³å°/é–€å¸‚/å‡ºè²¨æ—¥/å–è²¨æœŸé™<br/>
        - æ”¶æ¬¾ç«¯å‹¾é¸ â†’ ä¸€éµå¸¶å…¥ SMSï¼ˆé›²ç«¯ ordersï¼Œä¾è¨‚å–®è™Ÿå« # å»é‡/æ›´æ–°ï¼‰<br/>
        - æ”¶æ¬¾ç«¯æ¨™è¨˜å·²å–è²¨ â†’ SMS ç«¯ä¾è¨‚å–®è™ŸåŒæ­¥åˆªé™¤
      </p>
    </div>

    <div class="shell-tabs">
      <button class="shell-tab active" onclick="mainSwitch('pay')">ğŸ§¾ æ”¶æ¬¾æ—¥æœŸ / è¨‚å–®</button>
      <button class="shell-tab" onclick="mainSwitch('sms')">ğŸ“± SMS å®¢æˆ¶ç®¡ç†</button>
    </div>

    <div class="shell-content">
      <!-- ================= PAY ================= -->
      <div id="main-pay" class="shell-panel active">
        <div class="pay-tabs">
          <button class="pay-tab active" onclick="pay_switchTab(event,'calc')">ğŸ“… æ—¥æœŸè¨ˆç®—å™¨</button>
          <button class="pay-tab" onclick="pay_switchTab(event,'orders')">ğŸ“¦ è¨‚å–®ç®¡ç†</button>
          <button class="pay-tab" onclick="pay_switchTab(event,'import')">ğŸ“Š Excel æ‰¹é‡åŒ¯å…¥</button>
        </div>

        <div id="pay-calc" class="pay-panel active">
          <div class="pay-form-group">
            <label>é¸æ“‡å¹³å°</label>
            <select id="payPlatform" class="pay-select">
              <option value="è³£è²¨ä¾¿">è³£è²¨ä¾¿</option>
              <option value="å¥½è³£+">å¥½è³£+</option>
            </select>
          </div>
          <div class="pay-form-group">
            <label>å–è²¨æ—¥æœŸ</label>
            <input type="date" id="payPickupDate" class="pay-input" />
          </div>
          <button class="pay-btn pay-btn-primary" onclick="pay_calculateDate()">è¨ˆç®—</button>

          <div id="payResult" class="pay-result">
            <h3>è¨ˆç®—çµæœ</h3>
            <div class="pay-result-row"><span>å–è²¨æ—¥æœŸ</span><strong id="payResultPickup"></strong></div>
            <div class="pay-result-row"><span>çµç®—æ—¥æœŸ</span><strong id="payResultSettlement"></strong></div>
            <div class="pay-result-row"><span>åŒ¯æ¬¾æ—¥æœŸ</span><strong id="payResultPayment"></strong></div>
          </div>

          <div class="pay-hint">
            é€™è£¡åªåšæ”¶æ¬¾é‚è¼¯ï¼ˆå–è²¨æ—¥ â†’ çµç®—æ—¥ â†’ åŒ¯æ¬¾æ—¥ï¼‰ï¼Œèˆ‡ SMS é€šçŸ¥ç³»çµ±åˆ†é–‹ã€‚
          </div>
        </div>

        <div id="pay-orders" class="pay-panel">
          <div class="pay-stats">
            <div class="pay-stat-card"><h3 id="payTotalOrders">0</h3><p>ç¸½è¨‚å–®æ•¸</p></div>
            <div class="pay-stat-card"><h3 id="payPendingOrders">0</h3><p>å¾…å–è²¨</p></div>
            <div class="pay-stat-card"><h3 id="payPickedOrders">0</h3><p>å·²å–è²¨</p></div>
          </div>

          <div class="pay-form-grid">
            <div class="pay-form-group">
              <label>è¨‚å–®è™Ÿ *</label>
              <input type="text" id="payOrderNumber" class="pay-input" placeholder="#1468" />
            </div>
            <div class="pay-form-group">
              <label>å§“å *</label>
              <input type="text" id="payCustomerName" class="pay-input" placeholder="ç‹å°æ˜" />
            </div>
            <div class="pay-form-group">
              <label>é›»è©± *</label>
              <input type="tel" id="payPhone" class="pay-input" placeholder="0912345678" />
            </div>
            <div class="pay-form-group">
              <label>å¹³å° *</label>
              <select id="payOrderPlatform" class="pay-select">
                <option value="è³£è²¨ä¾¿">è³£è²¨ä¾¿</option>
                <option value="å¥½è³£+">å¥½è³£+</option>
              </select>
            </div>
            <div class="pay-form-group">
              <label>é–€å¸‚ï¼ˆå»ºè­°ï¼šå…¨å®¶ å°åŒ—è»Šç«™åº—ï¼‰</label>
              <input type="text" id="payStore" class="pay-input" placeholder="å…¨å®¶ å°åŒ—è»Šç«™åº—" />
            </div>
            <div class="pay-form-group">
              <label>å‡ºè²¨æ—¥ *</label>
              <input type="date" id="payOrderShipDate" class="pay-input" />
            </div>
            <div class="pay-form-group">
              <label>å–è²¨æœŸé™</label>
              <input type="date" id="payPickupDeadline" class="pay-input" />
            </div>
          </div>

          <button class="pay-btn pay-btn-primary" onclick="pay_addOrder()">æ–°å¢è¨‚å–®</button>

          <div class="pay-actions">
            <button class="pay-btn pay-btn-warning" onclick="pay_pushSelectedToSMS()">ğŸ“¤ ä¸€éµå¸¶å…¥ SMSï¼ˆé¸å–ï¼‰</button>
            <button class="pay-btn pay-btn-success" onclick="pay_batchPickupToday()">âœ… æ‰¹é‡å–è²¨ï¼ˆå–è²¨æ—¥=ä»Šå¤©ï¼‰</button>
            <button class="pay-btn pay-btn-danger" onclick="pay_batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤</button>
            <button class="pay-btn pay-btn-secondary" onclick="pay_exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
            <button class="pay-btn pay-btn-danger" onclick="pay_clearAllOrders()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
          </div>

          <div class="pay-table-wrap">
            <table class="pay-table">
              <thead>
                <tr>
                  <th class="pay-checkbox-cell"><input type="checkbox" id="paySelectAll" onchange="pay_toggleSelectAll()" /></th>
                  <th>è¨‚å–®è™Ÿ</th>
                  <th>å§“å</th>
                  <th>é›»è©±</th>
                  <th>å¹³å°</th>
                  <th>é–€å¸‚</th>
                  <th>å‡ºè²¨æ—¥</th>
                  <th>å–è²¨æœŸé™</th>
                  <th>å–è²¨æ—¥</th>
                  <th>çµç®—æ—¥</th>
                  <th>åŒ¯æ¬¾æ—¥</th>
                  <th>ç‹€æ…‹</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="payOrderTableBody"></tbody>
            </table>
          </div>

          <div class="pay-hint">
            è¨‚å–®è™Ÿæœƒè‡ªå‹•æ­£è¦åŒ–æˆ <code>#xxxx</code> å¾Œå†åŒæ­¥/åˆªé™¤ï¼ˆå³ä½¿åŒ¯å…¥æ™‚æ¼æ‰“ # ä¹Ÿä¸æœƒå½±éŸ¿ï¼‰ã€‚
          </div>
        </div>

        <div id="pay-import" class="pay-panel">
          <h3 style="margin: 8px 0 10px 0;">ğŸ“Š Excel æ‰¹é‡åŒ¯å…¥è¨‚å–®</h3>
          <div class="pay-upload" onclick="document.getElementById('payFileInput').click()">
            <div style="font-size: 18px; font-weight: 900; margin-bottom: 6px;">é»æ“Šä¸Šå‚³ Excel</div>
            <div style="color:#666; font-size: 13px;">æ¬„ä½ï¼šè¨‚å–®è™Ÿ / å§“å / é›»è©± / å¹³å° / é–€å¸‚ / å‡ºè²¨æ—¥ / å–è²¨æœŸé™</div>
            <input type="file" id="payFileInput" accept=".xlsx,.xls" onchange="pay_handleFileUpload(event)">
          </div>
          <div class="pay-hint">
            å»ºè­°æ¬„ä½åç¨±ï¼šè¨‚å–®è™Ÿã€å§“åã€é›»è©±ã€å¹³å°ã€é–€å¸‚ã€å‡ºè²¨æ—¥ã€å–è²¨æœŸé™ï¼ˆæ¬„ä½åå‰å¾Œç©ºç™½ä¹Ÿæ”¯æ´ï¼‰
          </div>
          <div style="margin-top: 12px;">
            <button class="pay-btn pay-btn-secondary" onclick="pay_downloadTemplate()">ä¸‹è¼‰ç¯„æœ¬</button>
          </div>
        </div>
      </div>

      <!-- ================= SMS ================= -->
      <div id="main-sms" class="shell-panel">
        <div class="sms-container">
          <div class="sms-header">
            <h1>ğŸ“± SMS å®¢æˆ¶ç®¡ç†ç³»çµ±</h1>
            <div class="sms-sync-status">
              <div class="sms-sync-indicator" id="smsSyncIndicator"></div>
              <span id="smsSyncStatus">é›²ç«¯åŒæ­¥ä¸­...</span>
            </div>
          </div>

          <div class="sms-tabs">
            <button class="sms-tab active" onclick="sms_switchTab(event,'orders')">ğŸ“‹ è¨‚å–®ç®¡ç†</button>
            <button class="sms-tab" onclick="sms_switchTab(event,'templates')">ğŸ’¬ ç°¡è¨Šç¯„æœ¬</button>
            <button class="sms-tab" onclick="sms_switchTab(event,'send')">ğŸ“¤ ç™¼é€ç°¡è¨Š</button>
          </div>

          <div id="smsOrdersTab" class="sms-tab-content active">
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_showAddOrderModal()">â• æ–°å¢å–®ç­†è¨‚å–®</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_showBulkImportModal()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥</button>
              <button class="sms-btn sms-btn-success" onclick="sms_exportOrders()">ğŸ’¾ åŒ¯å‡ºè¨‚å–®</button>
              <button class="sms-btn sms-btn-danger" onclick="sms_clearAllOrders()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
            </div>
            <div id="smsOrdersList"></div>
          </div>

          <div id="smsTemplatesTab" class="sms-tab-content">
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_showAddTemplateModal()">â• æ–°å¢ç¯„æœ¬</button>
              <button class="sms-btn sms-btn-success" onclick="sms_exportTemplates()">ğŸ’¾ åŒ¯å‡ºç¯„æœ¬</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_importTemplates()">ğŸ“¥ åŒ¯å…¥ç¯„æœ¬</button>
            </div>
            <div id="smsTemplatesList"></div>
          </div>

          <div id="smsSendTab" class="sms-tab-content">
            <div class="sms-form-group">
              <label>
                <input type="checkbox" id="smsSelectAllOrders" onchange="sms_toggleSelectAll()">
                å…¨é¸æ‰€æœ‰è¨‚å–®
              </label>
            </div>

            <div class="sms-form-group">
              <label>é¸æ“‡ç°¡è¨Šç¯„æœ¬</label>
              <select id="smsTemplateSelect" onchange="sms_previewTemplate()">
                <option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>
              </select>
            </div>

            <div class="sms-form-group">
              <label>ç¯„æœ¬å…§å®¹ï¼ˆå¯ç·¨è¼¯ï¼‰</label>
              <textarea id="smsTemplatePreview" placeholder="é¸æ“‡ç¯„æœ¬å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
            </div>

            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_applyTemplateToSelected()">âœ… å¥—ç”¨åˆ°é¸å–çš„å®¢æˆ¶</button>
              <button class="sms-btn sms-btn-warning" onclick="sms_saveDrafts()">ğŸ’¾ å„²å­˜è‰ç¨¿</button>
              <button class="sms-btn sms-btn-success" onclick="sms_startSending()">ğŸ“¤ é–‹å§‹ç™¼é€ç°¡è¨Š</button>
            </div>

            <div id="smsSendOrdersList"></div>
          </div>
        </div>

        <!-- æ–°å¢è¨‚å–® Modal -->
        <div id="smsAddOrderModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ–°å¢è¨‚å–®</div>
            <div class="sms-form-group">
              <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
              <input type="tel" id="smsOrderPhone" placeholder="0912345678">
            </div>
            <div class="sms-form-group">
              <label>å®¢æˆ¶å§“å *</label>
              <input type="text" id="smsOrderName" placeholder="ç‹å°æ˜">
            </div>
            <div class="sms-form-group">
              <label>è¨‚å–®è™Ÿç¢¼</label>
              <input type="text" id="smsOrderNumber" placeholder="#1468">
            </div>
            <div class="sms-form-group">
              <label>é–€å¸‚é¡åˆ¥</label>
              <select id="smsOrderStoreType">
                <option value="å…¨å®¶">å…¨å®¶</option>
                <option value="7-11">7-11</option>
                <option value="èŠçˆ¾å¯Œ">èŠçˆ¾å¯Œ</option>
                <option value="OKè¶…å•†">OKè¶…å•†</option>
              </select>
            </div>
            <div class="sms-form-group">
              <label>é–€å¸‚åç¨±</label>
              <input type="text" id="smsOrderStoreName" placeholder="å°åŒ—è»Šç«™åº—">
            </div>
            <div class="sms-form-group">
              <label>å–è²¨æœŸé™</label>
              <input type="date" id="smsOrderDeadline">
            </div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_addOrder()">âœ… ç¢ºèªæ–°å¢</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsAddOrderModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <!-- æ‰¹é‡åŒ¯å…¥ Modal -->
        <div id="smsBulkImportModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ‰¹é‡åŒ¯å…¥è¨‚å–®</div>
            <div class="sms-alert">
              è«‹è²¼ä¸Š Excel è³‡æ–™ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ã€å§“åã€è¨‚å–®è™Ÿç¢¼ã€é–€å¸‚é¡åˆ¥ã€é–€å¸‚åç¨±ã€å–è²¨æœŸé™ï¼ˆTab æˆ–é€—è™Ÿåˆ†éš”ï¼‰
            </div>
            <div class="sms-form-group">
              <label>è²¼ä¸Šè³‡æ–™</label>
              <textarea id="smsBulkImportData" rows="10" placeholder="0912345678	ç‹å°æ˜	#1468	å…¨å®¶	å°åŒ—è»Šç«™åº—	2026/01/20"></textarea>
            </div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_bulkImport()">âœ… ç¢ºèªåŒ¯å…¥</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsBulkImportModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <!-- æ–°å¢ç¯„æœ¬ Modal -->
        <div id="smsAddTemplateModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">æ–°å¢ç°¡è¨Šç¯„æœ¬</div>
            <div class="sms-alert">
              å¯ç”¨è®Šæ•¸ï¼š{customerName}ã€{orderNumber}ã€{storeType}ã€{storeName}ã€{pickupDeadline}
            </div>
            <div class="sms-form-group">
              <label>ç¯„æœ¬åç¨± *</label>
              <input type="text" id="smsTemplateName" placeholder="å–è²¨é€šçŸ¥">
            </div>
            <div class="sms-form-group">
              <label>ç¯„æœ¬å…§å®¹ *</label>
              <textarea id="smsTemplateContent" placeholder="è¦ªæ„›çš„{customerName}æ‚¨å¥½ï¼Œæ‚¨çš„è¨‚å–®{orderNumber}å·²é€é”{storeType}{storeName}ï¼Œè«‹æ–¼{pickupDeadline}å‰å–è²¨ã€‚"></textarea>
            </div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_addTemplate()">âœ… ç¢ºèªæ–°å¢</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsAddTemplateModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

        <!-- ç·¨è¼¯ç°¡è¨Š Modal -->
        <div id="smsEditSmsModal" class="sms-modal">
          <div class="sms-modal-content">
            <div class="sms-modal-header">ç·¨è¼¯ç°¡è¨Šå…§å®¹</div>
            <div class="sms-form-group">
              <label>å®¢æˆ¶ï¼š<span id="smsEditSmsCustomer"></span></label>
            </div>
            <div class="sms-form-group">
              <label>ç°¡è¨Šå…§å®¹</label>
              <textarea id="smsEditSmsContent" rows="6"></textarea>
            </div>
            <div class="sms-button-group">
              <button class="sms-btn sms-btn-primary" onclick="sms_saveEditedSms()">âœ… å„²å­˜</button>
              <button class="sms-btn sms-btn-secondary" onclick="sms_closeModal('smsEditSmsModal')">âŒ å–æ¶ˆ</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /* ========================= Main Switch ========================= */
    function mainSwitch(which) {
      document.querySelectorAll('.shell-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.shell-panel').forEach(p => p.classList.remove('active'));

      if (which === 'pay') {
        document.querySelectorAll('.shell-tab')[0].classList.add('active');
        document.getElementById('main-pay').classList.add('active');
        document.getElementById('smsResetBtn').style.display = 'none';
      } else {
        document.querySelectorAll('.shell-tab')[1].classList.add('active');
        document.getElementById('main-sms').classList.add('active');
        document.getElementById('smsResetBtn').style.display = 'block';
      }
    }

    /* ========================= Pay Logic ========================= */
    function pay_switchTab(evt, tabName) {
      document.querySelectorAll('.pay-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.pay-panel').forEach(p => p.classList.remove('active'));
      evt.target.classList.add('active');
      document.getElementById('pay-' + tabName).classList.add('active');
      if (tabName === 'orders') pay_loadOrders();
    }

    function pay_pad2(n){ return String(n).padStart(2,'0'); }
    function pay_formatDate(d){ return `${d.getFullYear()}/${pay_pad2(d.getMonth()+1)}/${pay_pad2(d.getDate())}`; }
    function pay_formatDateInput(d){ return `${d.getFullYear()}-${pay_pad2(d.getMonth()+1)}-${pay_pad2(d.getDate())}`; }
    function pay_weekday(d){ return ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()]; }
    function pay_addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
    function pay_nextWeekday(date, targetDay){
      const d=new Date(date);
      const cur=d.getDay();
      let add=targetDay-cur;
      if(add<=0) add+=7;
      d.setDate(d.getDate()+add);
      return d;
    }

    function pay_normalizeOrderNumber(raw){
      const s = String(raw || '').trim();
      if(!s) return '';
      return s.startsWith('#') ? s : ('#' + s);
    }
    function pay_normalizePhone(p){ return String(p || '').trim().replace(/\s+/g,''); }

    function pay_parseExcelDate(value){
      if(value instanceof Date) return value;
      if(typeof value === 'number' && isFinite(value)){
        const excelEpoch = new Date(1899,11,30);
        return new Date(excelEpoch.getTime() + value*86400000);
      }
      if(typeof value === 'string'){
        const s=value.trim();
        if(!s) return null;
        const m=s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if(m){
          const d=new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
          return isNaN(d.getTime())?null:d;
        }
        const d2=new Date(s);
        return isNaN(d2.getTime())?null:d2;
      }
      return null;
    }

    function pay_calculatePayment(platform, pickupDate){
      const dow = pickupDate.getDay();
      let settlement, payment;
      if(platform === 'è³£è²¨ä¾¿'){
        if(dow >= 1 && dow <= 3){
          settlement = pay_nextWeekday(pickupDate, 4);
          payment = pay_addDays(settlement, 4);
        } else {
          settlement = pay_nextWeekday(pickupDate, 1);
          payment = pay_addDays(settlement, 2);
        }
      } else if(platform === 'å¥½è³£+'){
        if(dow >= 1 && dow <= 3){
          settlement = pay_nextWeekday(pickupDate, 5);
          payment = pay_addDays(settlement, 4);
        } else {
          settlement = pay_nextWeekday(pickupDate, 3);
          payment = pay_addDays(settlement, 1);
        }
      }
      return { settlement, payment };
    }

    function pay_calculateDate(){
      const platform = document.getElementById('payPlatform').value;
      const pickupStr = document.getElementById('payPickupDate').value;
      if(!pickupStr) return alert('è«‹é¸æ“‡å–è²¨æ—¥æœŸ');
      const pickup = new Date(pickupStr);
      if(isNaN(pickup.getTime())) return alert('å–è²¨æ—¥æœŸæ ¼å¼éŒ¯èª¤');

      const r = pay_calculatePayment(platform, pickup);
      if(!r.settlement || !r.payment) return alert('å¹³å°è¨­å®šç•°å¸¸ï¼Œç„¡æ³•è¨ˆç®—');

      document.getElementById('payResultPickup').textContent = `${pay_formatDate(pickup)} (${pay_weekday(pickup)})`;
      document.getElementById('payResultSettlement').textContent = `${pay_formatDate(r.settlement)} (${pay_weekday(r.settlement)})`;
      document.getElementById('payResultPayment').textContent = `${pay_formatDate(r.payment)} (${pay_weekday(r.payment)})`;
      document.getElementById('payResult').style.display = 'block';
    }

    function pay_getOrders(){
      try { return JSON.parse(localStorage.getItem('pay_orders_final') || '[]'); }
      catch { return []; }
    }
    function pay_saveOrders(orders){
      localStorage.setItem('pay_orders_final', JSON.stringify(orders));
    }

    function pay_addOrder(){
      const orderNumber = pay_normalizeOrderNumber(document.getElementById('payOrderNumber').value);
      const customerName = document.getElementById('payCustomerName').value.trim();
      const phone = pay_normalizePhone(document.getElementById('payPhone').value);
      const platform = document.getElementById('payOrderPlatform').value;
      const store = document.getElementById('payStore').value.trim();
      const shipStr = document.getElementById('payOrderShipDate').value;
      const deadlineStr = document.getElementById('payPickupDeadline').value;

      if(!orderNumber) return alert('è«‹è¼¸å…¥è¨‚å–®è™Ÿ');
      if(!customerName) return alert('è«‹è¼¸å…¥å§“å');
      if(!phone) return alert('è«‹è¼¸å…¥é›»è©±');
      if(!shipStr) return alert('è«‹é¸æ“‡å‡ºè²¨æ—¥');

      const ship = new Date(shipStr);
      if(isNaN(ship.getTime())) return alert('å‡ºè²¨æ—¥æ ¼å¼éŒ¯èª¤');

      let pickupDeadline = '';
      if (deadlineStr) {
        const d = new Date(deadlineStr);
        if (!isNaN(d.getTime())) pickupDeadline = pay_formatDateInput(d);
      }

      const orders = pay_getOrders();
      orders.push({
        id: Date.now() + Math.random(),
        orderNumber,
        customerName,
        phone,
        platform,
        store,
        shipDate: pay_formatDate(ship),
        pickupDeadline,
        pickupDate: '-',
        settlementDate: '-',
        paymentDate: '-',
        status: 'å¾…å–è²¨'
      });
      pay_saveOrders(orders);

      document.getElementById('payOrderNumber').value = '';
      document.getElementById('payCustomerName').value = '';
      document.getElementById('payPhone').value = '';
      document.getElementById('payStore').value = '';
      document.getElementById('payOrderShipDate').value = '';
      document.getElementById('payPickupDeadline').value = '';

      pay_loadOrders();
    }

    function pay_deleteOrder(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')) return;
      let orders = pay_getOrders();
      orders = orders.filter(o => o.id !== id);
      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_syncDeleteSMS(orderNumbers){
      if (window.sms_removeOrdersByOrderNumbers && Array.isArray(orderNumbers) && orderNumbers.length > 0) {
        window.sms_removeOrdersByOrderNumbers(orderNumbers.map(pay_normalizeOrderNumber));
      }
    }

    function pay_savePickupDate(id){
      const input = document.querySelector(`input[data-pay-pickup="${id}"]`);
      if(!input || !input.value) return alert('è«‹é¸æ“‡å–è²¨æ—¥æœŸ');
      const pickup = new Date(input.value);
      if(isNaN(pickup.getTime())) return alert('å–è²¨æ—¥æœŸæ ¼å¼éŒ¯èª¤');

      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      const r = pay_calculatePayment(o.platform, pickup);
      o.pickupDate = pay_formatDate(pickup);
      o.settlementDate = pay_formatDate(r.settlement);
      o.paymentDate = pay_formatDate(r.payment);
      o.status = 'å·²å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();

      pay_syncDeleteSMS([o.orderNumber]);
    }

    function pay_pickupToday(id){
      const today = new Date();
      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      const r = pay_calculatePayment(o.platform, today);
      o.pickupDate = pay_formatDate(today);
      o.settlementDate = pay_formatDate(r.settlement);
      o.paymentDate = pay_formatDate(r.payment);
      o.status = 'å·²å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();

      pay_syncDeleteSMS([o.orderNumber]);
    }

    function pay_resetPickup(id){
      if(!confirm('è¦é‡è¨­å–è²¨è³‡è¨Šå—ï¼Ÿï¼ˆçµç®—/åŒ¯æ¬¾ä¹Ÿæœƒæ¸…ç©ºï¼‰')) return;
      const orders = pay_getOrders();
      const o = orders.find(x => x.id === id);
      if(!o) return;

      o.pickupDate = '-';
      o.settlementDate = '-';
      o.paymentDate = '-';
      o.status = 'å¾…å–è²¨';

      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_toggleSelectAll(){
      const all = document.getElementById('paySelectAll').checked;
      document.querySelectorAll('.pay-order-checkbox').forEach(cb => cb.checked = all);
    }
    function pay_selectedIds(){
      return Array.from(document.querySelectorAll('.pay-order-checkbox:checked'))
        .map(cb => Number(cb.getAttribute('data-id')))
        .filter(n => !Number.isNaN(n));
    }

    function pay_batchPickupToday(){
      const ids = pay_selectedIds();
      if(ids.length === 0) return alert('è«‹å…ˆå‹¾é¸è¦å–è²¨çš„è¨‚å–®');
      if(!confirm(`ç¢ºå®šè¦å°‡ ${ids.length} ç­†è¨‚å–®å–è²¨æ—¥è¨­ç‚ºä»Šå¤©å—ï¼Ÿ`)) return;

      const today = new Date();
      const orders = pay_getOrders();
      const pickedOrderNumbers = [];

      orders.forEach(o => {
        if(!ids.includes(o.id)) return;
        if(o.status !== 'å¾…å–è²¨') return;
        const r = pay_calculatePayment(o.platform, today);
        o.pickupDate = pay_formatDate(today);
        o.settlementDate = pay_formatDate(r.settlement);
        o.paymentDate = pay_formatDate(r.payment);
        o.status = 'å·²å–è²¨';
        pickedOrderNumbers.push(o.orderNumber);
      });

      pay_saveOrders(orders);
      pay_loadOrders();

      pay_syncDeleteSMS(pickedOrderNumbers);
    }

    function pay_batchDelete(){
      const ids = pay_selectedIds();
      if(ids.length === 0) return alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è¨‚å–®');
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${ids.length} ç­†è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

      let orders = pay_getOrders();
      orders = orders.filter(o => !ids.includes(o.id));
      pay_saveOrders(orders);
      pay_loadOrders();
    }

    function pay_clearAllOrders(){
      if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      localStorage.removeItem('pay_orders_final');
      pay_loadOrders();
    }

    function pay_loadOrders(){
      const orders = pay_getOrders();
      const tbody = document.getElementById('payOrderTableBody');
      tbody.innerHTML = '';

      let pending = 0, picked = 0;
      orders.forEach(o => {
        if(o.status === 'å¾…å–è²¨') pending++;
        if(o.status === 'å·²å–è²¨') picked++;

        const tr = document.createElement('tr');

        const td0 = document.createElement('td');
        td0.className = 'pay-checkbox-cell';
        td0.innerHTML = `<input type="checkbox" class="pay-order-checkbox" data-id="${o.id}">`;
        tr.appendChild(td0);

        const td1 = document.createElement('td'); td1.textContent = o.orderNumber || ''; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = o.customerName || ''; tr.appendChild(td2);
        const td3 = document.createElement('td'); td3.textContent = o.phone || ''; tr.appendChild(td3);
        const td4 = document.createElement('td'); td4.textContent = o.platform || ''; tr.appendChild(td4);
        const td5 = document.createElement('td'); td5.textContent = o.store || ''; tr.appendChild(td5);
        const td6 = document.createElement('td'); td6.textContent = o.shipDate || ''; tr.appendChild(td6);

        const td7 = document.createElement('td');
        td7.textContent = o.pickupDeadline ? o.pickupDeadline : '-';
        tr.appendChild(td7);

        const td8 = document.createElement('td');
        if(o.status === 'å¾…å–è²¨'){
          td8.innerHTML = `
            <div class="pay-pickup-inline">
              <input type="date" data-pay-pickup="${o.id}">
              <button class="pay-btn pay-btn-primary pay-btn-sm" onclick="pay_savePickupDate(${o.id})">å„²å­˜</button>
              <button class="pay-btn pay-btn-success pay-btn-sm" onclick="pay_pickupToday(${o.id})">ä»Šå¤©</button>
            </div>
          `;
        } else {
          td8.innerHTML = `${o.pickupDate} <button class="pay-btn pay-btn-secondary pay-btn-sm" onclick="pay_resetPickup(${o.id})">é‡è¨­</button>`;
        }
        tr.appendChild(td8);

        const td9 = document.createElement('td'); td9.textContent = o.settlementDate || '-'; tr.appendChild(td9);
        const td10 = document.createElement('td'); td10.textContent = o.paymentDate || '-'; tr.appendChild(td10);

        const td11 = document.createElement('td');
        td11.className = (o.status === 'å¾…å–è²¨') ? 'pay-status-pending' : 'pay-status-picked';
        td11.textContent = o.status;
        tr.appendChild(td11);

        const td12 = document.createElement('td');
        td12.innerHTML = `<button class="pay-btn pay-btn-danger pay-btn-sm" onclick="pay_deleteOrder(${o.id})">åˆªé™¤</button>`;
        tr.appendChild(td12);

        tbody.appendChild(tr);
      });

      document.getElementById('payTotalOrders').textContent = orders.length;
      document.getElementById('payPendingOrders').textContent = pending;
      document.getElementById('payPickedOrders').textContent = picked;
      const selectAll = document.getElementById('paySelectAll');
      if(selectAll) selectAll.checked = false;
    }

    function pay_exportToExcel(){
      const orders = pay_getOrders();
      if(orders.length === 0) return alert('æ²’æœ‰è¨‚å–®å¯ä»¥åŒ¯å‡º');

      const data = orders.map(o => ({
        'è¨‚å–®è™Ÿ': o.orderNumber,
        'å§“å': o.customerName,
        'é›»è©±': o.phone,
        'å¹³å°': o.platform,
        'é–€å¸‚': o.store,
        'å‡ºè²¨æ—¥': o.shipDate,
        'å–è²¨æœŸé™': o.pickupDeadline,
        'å–è²¨æ—¥': o.pickupDate,
        'çµç®—æ—¥': o.settlementDate,
        'åŒ¯æ¬¾æ—¥': o.paymentDate,
        'ç‹€æ…‹': o.status
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'è¨‚å–®åˆ—è¡¨');
      XLSX.writeFile(wb, `æ•´åˆè¨‚å–®_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function pay_trimHeaderRow(row){
      const out = {};
      Object.keys(row || {}).forEach(k => out[String(k).trim()] = row[k]);
      return out;
    }
    function pay_findField(obj, keys){
      for (const k of keys){ if (obj[k] !== undefined) return obj[k]; }
      return undefined;
    }

    function pay_handleFileUpload(event){
      const file = event.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type:'array', cellDates:true });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { raw:true });

          let orders = pay_getOrders();
          let success = 0, fail = 0;

          rows.forEach(row => {
            const r = pay_trimHeaderRow(row);

            const orderNumberRaw = pay_findField(r, ['è¨‚å–®è™Ÿ','è¨‚å–®ç·¨è™Ÿ','è®¢å•å·','è®¢å•ç¼–å·','è¨‚å–®']);
            const customerName = pay_findField(r, ['å§“å','å®¢æˆ¶å§“å','å®¢æˆ·å§“å','æ”¶ä»¶äºº','å®¢æˆ¶','å®¢æˆ·']);
            const phoneRaw = pay_findField(r, ['é›»è©±','æ‰‹æ©Ÿ','æ‰‹æ©Ÿè™Ÿç¢¼','æ‰‹æœºå·','é›»è©±è™Ÿç¢¼','æ‰‹æœºå·ç ','phone']);
            const platform = pay_findField(r, ['å¹³å°']);
            const store = pay_findField(r, ['é–€å¸‚','å–è²¨é–€å¸‚','é—¨å¸‚','å–ä»¶é—¨å¸‚','åº—','é–€å¸‚åç¨±','é—¨åº—']);
            const shipRaw = pay_findField(r, ['å‡ºè²¨æ—¥','å‡ºè²¨æ—¥æœŸ','å‡ºè´§æ—¥','å‡ºè´§æ—¥æœŸ','å‡ºè²¨']);
            const deadlineRaw = pay_findField(r, ['å–è²¨æœŸé™','å–è²¨åˆ°æœŸæ—¥','å–ä»¶æœŸé™','å–ä»¶åˆ°æœŸæ—¥','å–è´§æœŸé™','å–è´§åˆ°æœŸæ—¥','pickupDeadline']);

            if(!orderNumberRaw || !customerName || !phoneRaw || !platform || !shipRaw){ fail++; return; }

            const ship = pay_parseExcelDate(shipRaw);
            if(!ship || isNaN(ship.getTime())){ fail++; return; }

            let pickupDeadline = '';
            if (deadlineRaw !== undefined && deadlineRaw !== null && String(deadlineRaw).trim() !== '') {
              const dd = pay_parseExcelDate(deadlineRaw);
              if (dd && !isNaN(dd.getTime())) pickupDeadline = pay_formatDateInput(dd);
            }

            orders.push({
              id: Date.now() + Math.random(),
              orderNumber: pay_normalizeOrderNumber(orderNumberRaw),
              customerName: String(customerName).trim(),
              phone: pay_normalizePhone(phoneRaw),
              platform: String(platform).trim(),
              store: store ? String(store).trim() : '',
              shipDate: pay_formatDate(ship),
              pickupDeadline,
              pickupDate: '-',
              settlementDate: '-',
              paymentDate: '-',
              status: 'å¾…å–è²¨'
            });
            success++;
          });

          pay_saveOrders(orders);
          alert(`åŒ¯å…¥å®Œæˆï¼šæˆåŠŸ ${success} ç­†ï¼Œå¤±æ•— ${fail} ç­†`);
          document.querySelectorAll('.pay-tab')[1].click();
          pay_loadOrders();
        } catch(err){
          alert('åŒ¯å…¥å¤±æ•—ï¼š' + (err && err.message ? err.message : String(err)));
        } finally {
          event.target.value = '';
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function pay_downloadTemplate(){
      const template = [
        { 'è¨‚å–®è™Ÿ': '#1468', 'å§“å': 'ç‹å°æ˜', 'é›»è©±': '0912345678', 'å¹³å°': 'è³£è²¨ä¾¿', 'é–€å¸‚': 'å…¨å®¶ å°åŒ—è»Šç«™åº—', 'å‡ºè²¨æ—¥': '2026/1/5', 'å–è²¨æœŸé™': '2026/1/12' },
        { 'è¨‚å–®è™Ÿ': '#1477', 'å§“å': 'é™³å°è¯', 'é›»è©±': '0987654321', 'å¹³å°': 'å¥½è³£+', 'é–€å¸‚': '7-11 ä¿¡ç¾©é–€å¸‚', 'å‡ºè²¨æ—¥': '2026/1/5', 'å–è²¨æœŸé™': '2026/1/12' }
      ];
      const ws = XLSX.utils.json_to_sheet(template);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'åŒ¯å…¥ç¯„æœ¬');
      XLSX.writeFile(wb, 'æ•´åˆç³»çµ±_åŒ¯å…¥ç¯„æœ¬.xlsx');
    }

    function pay_pushSelectedToSMS(){
      const ids = pay_selectedIds();
      if (ids.length === 0) return alert('è«‹å…ˆå‹¾é¸è¦å¸¶å…¥ SMS çš„è¨‚å–®');

      const orders = pay_getOrders();
      const selected = orders.filter(o => ids.includes(o.id));
      const valid = selected
        .map(o => ({
          orderNumber: pay_normalizeOrderNumber(o.orderNumber),
          customerName: o.customerName,
          phone: o.phone,
          store: o.store || '',
          pickupDeadline: o.pickupDeadline || ''
        }))
        .filter(o => o.orderNumber && o.customerName && o.phone);

      if (valid.length === 0) return alert('å‹¾é¸çš„è¨‚å–®ç¼ºå°‘ã€Œè¨‚å–®è™Ÿ/å§“å/é›»è©±ã€ï¼Œç„¡æ³•å¸¶å…¥ SMS');
      if (!window.sms_upsertOrdersFromPay) {
        return alert('SMS æ¨¡çµ„å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨ç­‰ 2 ç§’å†è©¦ä¸€æ¬¡ï¼ˆæˆ–åˆ‡åˆ° SMS åˆ†é è®“å®ƒåˆå§‹åŒ–ï¼‰ã€‚');
      }

      window.sms_upsertOrdersFromPay(valid);
      alert(`å·²å¸¶å…¥ SMSï¼š${valid.length} ç­†ï¼ˆä¾è¨‚å–®è™Ÿå»é‡/æ›´æ–°ï¼‰`);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const pd = document.getElementById('payPickupDate');
      if(pd) pd.valueAsDate = today;
      const sd = document.getElementById('payOrderShipDate');
      if(sd) sd.valueAsDate = today;
      pay_loadOrders();
    });
  </script>

  <!-- ========================= SMS Module (Firebase + Firestore history) ========================= -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDcKclyNssDs08E0DIwfrc7lzq3QQL4QS8",
      authDomain: "sms-miris.firebaseapp.com",
      databaseURL: "https://sms-miris-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sms-miris",
      storageBucket: "sms-miris.firebasestorage.app",
      messagingSenderId: "340097404227",
      appId: "1:340097404227:web:554901219608cbed42f3f6"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const db = getFirestore(app);

    const defaultTemplates = [
      {
        name: "åˆ°è²¨é€šçŸ¥(å·²ä»˜æ¬¾)",
        content: "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚:{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰æ”œå¸¶è­‰ä»¶å–è²¨ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"
      },
      {
        name: "ç¬¬ä¸€å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
        content: "ã€åŒ…è£¹å–ä»¶é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nç¾è‰çš„å®¶æ„Ÿè¬æ‚¨ã€‚"
      },
      {
        name: "ç¬¬3å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
        content: "ã€å–ä»¶å‰©é¤˜4æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†3æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
      },
      {
        name: "ç¬¬5å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
        content: "ã€å–ä»¶å‰©é¤˜2æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†5æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
      },
      {
        name: "ç¬¬6å¤© åˆ°è²¨é€šçŸ¥(æœªä»˜æ¬¾)",
        content: "ã€å–ä»¶æœ€å¾Œ1æ—¥é€šçŸ¥ã€‘\n{customerName} æ‚¨å¥½\næ‚¨åœ¨ç¾è‰çš„å®¶è¨‚è³¼çš„å•†å“ {orderNumber}\nå·²æŠµé”è¶…å•†6æ—¥ï¼ˆé–€å¸‚ï¼š{storeType} {storeName})\nè«‹æ‚¨å‹™å¿…æ–¼ã€{pickupDeadline}ã€‘å‰å®Œæˆå–è²¨ä»˜æ¬¾ã€‚\nä»¥é¿å…åŒ…è£¹é­é€€å›ï¼Œå½±éŸ¿æ‚¨æœªä¾†çš„è³¼ç‰©æ¬Šç›Šã€‚"
      }
    ];

    window.sms_orders = [];
    window.sms_templates = [];
    window.sms_selectedOrders = new Set();
    window.sms_smsContent = {};
    window.sms_currentEditingPhone = null;
    window.sms_sendHistory = {};

    function sms_normalizeOrderNumber(raw){
      const s = String(raw || '').trim();
      if(!s) return '';
      return s.startsWith('#') ? s : ('#' + s);
    }
    function sms_normalizePhone(raw){
      return String(raw || '').trim().replace(/\s+/g,'');
    }

    function sms_formatDateTime(isoString) {
      const date = new Date(isoString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${month}/${day} ${hours}:${minutes}`;
    }

    function sms_formatDateToMMDD(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${month}/${day}`;
    }

    function sms_parseStore(storeText) {
      const s = String(storeText || '').trim();
      if (!s) return { storeType: 'å…¨å®¶', storeName: '' };
      const knownTypes = ['å…¨å®¶', '7-11', 'èŠçˆ¾å¯Œ', 'OKè¶…å•†', 'OK', 'OKä¾¿åˆ©å•†åº—'];
      for (const t of knownTypes) {
        if (s.startsWith(t)) {
          const rest = s.slice(t.length).trim();
          return { storeType: (t === 'OK' || t === 'OKä¾¿åˆ©å•†åº—') ? 'OKè¶…å•†' : t, storeName: rest };
        }
      }
      const parts = s.split(/\s+/);
      if (parts.length >= 2) return { storeType: parts[0], storeName: parts.slice(1).join(' ') };
      return { storeType: 'å…¨å®¶', storeName: s };
    }

    // åŒæ­¥ç‹€æ…‹
    let sms_isOnline = navigator.onLine;
    function sms_updateSyncStatus() {
      const indicator = document.getElementById('smsSyncIndicator');
      const status = document.getElementById('smsSyncStatus');
      if (!indicator || !status) return;

      if (sms_isOnline) {
        indicator.classList.remove('offline');
        status.textContent = 'å·²é€£ç·š - å³æ™‚åŒæ­¥';
      } else {
        indicator.classList.add('offline');
        status.textContent = 'é›¢ç·šæ¨¡å¼';
      }
    }
    sms_updateSyncStatus();

    window.addEventListener('online', () => {
      sms_isOnline = true;
      sms_updateSyncStatus();
      sms_syncToCloud();
    });
    window.addEventListener('offline', () => {
      sms_isOnline = false;
      sms_updateSyncStatus();
    });

    async function sms_syncToCloud() {
      if (!sms_isOnline) return;
      try {
        await set(ref(database, 'orders'), window.sms_orders);
        await set(ref(database, 'templates'), window.sms_templates);
      } catch (error) {
        console.error('SMS åŒæ­¥å¤±æ•—:', error);
      }
    }
    window.sms_syncToCloud = sms_syncToCloud;

    // ç™¼é€è¨˜éŒ„ (Firestore)
    async function sms_recordSendHistory(phone, content) {
      const order = window.sms_orders.find(o => o.phone === phone);
      if (!order) return;

      const sendRef = doc(db, 'sendHistory', phone);
      try {
        const docSnap = await getDoc(sendRef);
        const now = new Date().toISOString();

        if (docSnap.exists()) {
          const data = docSnap.data();
          await setDoc(sendRef, {
            orderNumber: order.orderNumber,
            customerName: order.customerName,
            sendCount: (data.sendCount || 0) + 1,
            lastSentAt: now,
            history: [{ sentAt: now, content }, ...(data.history || [])].slice(0, 10)
          });
        } else {
          await setDoc(sendRef, {
            orderNumber: order.orderNumber,
            customerName: order.customerName,
            sendCount: 1,
            lastSentAt: now,
            history: [{ sentAt: now, content }]
          });
        }

        window.sms_sendHistory[phone] = (await getDoc(sendRef)).data();
      } catch (error) {
        console.error('è¨˜éŒ„ç™¼é€æ­·å²å¤±æ•—:', error);
      }
    }

    async function sms_loadSendHistory() {
      window.sms_sendHistory = {};
      try {
        for (const order of window.sms_orders) {
          const d = await getDoc(doc(db, 'sendHistory', order.phone));
          if (d.exists()) window.sms_sendHistory[order.phone] = d.data();
        }
      } catch (error) {
        console.error('è¼‰å…¥ç™¼é€è¨˜éŒ„å¤±æ•—:', error);
      }
    }

    // æ·±åº¦æ•´åˆ APIï¼šæ”¶æ¬¾ â†’ SMS (upsert)
    // items: [{orderNumber, customerName, phone, store, pickupDeadline}]
    window.sms_upsertOrdersFromPay = async function(items) {
      if (!Array.isArray(items) || items.length === 0) return;

      const normalized = items.map(x => ({
        orderNumber: sms_normalizeOrderNumber(x.orderNumber),
        customerName: String(x.customerName || '').trim(),
        phone: sms_normalizePhone(x.phone),
        store: String(x.store || '').trim(),
        pickupDeadline: String(x.pickupDeadline || '').trim()
      })).filter(x => x.orderNumber && x.customerName && x.phone);

      if (normalized.length === 0) return;

      const byOrder = new Map();
      window.sms_orders.forEach(o => {
        const key = sms_normalizeOrderNumber(o.orderNumber);
        if (key) byOrder.set(key, o);
      });

      normalized.forEach(x => {
        const exist = byOrder.get(x.orderNumber);
        const { storeType, storeName } = sms_parseStore(x.store);

        if (exist) {
          exist.phone = x.phone || exist.phone;
          exist.customerName = x.customerName || exist.customerName;
          exist.orderNumber = x.orderNumber || exist.orderNumber;
          exist.storeType = storeType || exist.storeType;
          exist.storeName = storeName || exist.storeName;
          exist.pickupDeadline = x.pickupDeadline || exist.pickupDeadline;
        } else {
          window.sms_orders.push({
            phone: x.phone,
            customerName: x.customerName,
            orderNumber: x.orderNumber,
            storeType,
            storeName,
            pickupDeadline: x.pickupDeadline || ''
          });
        }
      });

      await sms_syncToCloud();
      sms_renderOrders();
      await sms_loadSendHistory();
      sms_renderSendOrders();
    };

    // æ·±åº¦æ•´åˆ APIï¼šå·²å–è²¨ â†’ SMS åˆªé™¤
    window.sms_removeOrdersByOrderNumbers = async function(orderNumbers) {
      if (!Array.isArray(orderNumbers) || orderNumbers.length === 0) return;

      const setNums = new Set(orderNumbers.map(sms_normalizeOrderNumber).filter(Boolean));
      if (setNums.size === 0) return;

      const before = window.sms_orders.length;
      window.sms_orders = window.sms_orders.filter(o => !setNums.has(sms_normalizeOrderNumber(o.orderNumber)));

      // æ¸…æ‰é¸å–/è‰ç¨¿æ®˜ç•™
      window.sms_selectedOrders.forEach(phone => {
        const still = window.sms_orders.some(o => o.phone === phone);
        if (!still) window.sms_selectedOrders.delete(phone);
      });
      Object.keys(window.sms_smsContent || {}).forEach(phone => {
        const still = window.sms_orders.some(o => o.phone === phone);
        if (!still) delete window.sms_smsContent[phone];
      });

      if (window.sms_orders.length !== before) {
        await sms_syncToCloud();
        sms_renderOrders();
        await sms_loadSendHistory();
        sms_renderSendOrders();
      }
    };

    // é‡ç½®ç¯„æœ¬
    window.sms_resetTemplates = async function() {
      if (confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ç¯„æœ¬å—ï¼Ÿé€™æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰ç¯„æœ¬ï¼')) {
        window.sms_templates = defaultTemplates;
        await sms_syncToCloud();
        sms_renderTemplates();
        sms_updateTemplateSelect();
        alert('âœ… ç¯„æœ¬å·²é‡ç½®ï¼');
      }
    };

    // å¾ Firebase è¼‰å…¥è³‡æ–™
    async function sms_loadFromCloud() {
      const ordersRef = ref(database, 'orders');
      const templatesRef = ref(database, 'templates');

      onValue(ordersRef, async (snapshot) => {
        const data = snapshot.val();
        window.sms_orders = (data && Array.isArray(data)) ? data : [];
        // è®€å›ä¾†ä¹Ÿçµ±ä¸€è¨‚å–®è™Ÿå« #
        window.sms_orders.forEach(o => { o.orderNumber = sms_normalizeOrderNumber(o.orderNumber); o.phone = sms_normalizePhone(o.phone); });

        sms_renderOrders();
        await sms_loadSendHistory();
        sms_renderSendOrders();
      });

      const templatesSnapshot = await get(templatesRef);
      if (!templatesSnapshot.exists() || !templatesSnapshot.val() || templatesSnapshot.val().length === 0) {
        window.sms_templates = defaultTemplates;
        await sms_syncToCloud();
      }

      onValue(templatesRef, (snapshot) => {
        const data = snapshot.val();
        if (data && Array.isArray(data) && data.length > 0) window.sms_templates = data;
        sms_renderTemplates();
        sms_updateTemplateSelect();
      });
    }
    sms_loadFromCloud();

    // Tab åˆ‡æ›
    window.sms_switchTab = async function(evt, tabName) {
      document.querySelectorAll('.sms-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.sms-tab-content').forEach(content => content.classList.remove('active'));

      evt.target.classList.add('active');
      document.getElementById('sms' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');

      if (tabName === 'send') {
        await sms_loadSendHistory();
        sms_renderSendOrders();
      }
    };

    // Modal
    window.sms_showAddOrderModal = function(){ document.getElementById('smsAddOrderModal').classList.add('active'); };
    window.sms_showBulkImportModal = function(){ document.getElementById('smsBulkImportModal').classList.add('active'); };
    window.sms_showAddTemplateModal = function(){ document.getElementById('smsAddTemplateModal').classList.add('active'); };
    window.sms_closeModal = function(id){ document.getElementById(id).classList.remove('active'); };

    // è¨‚å–®æ“ä½œ
    window.sms_addOrder = function() {
      const phone = sms_normalizePhone(document.getElementById('smsOrderPhone').value);
      const name = String(document.getElementById('smsOrderName').value || '').trim();
      const orderNumber = sms_normalizeOrderNumber(document.getElementById('smsOrderNumber').value);

      if (!phone || !name) return alert('è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼å’Œå§“å');

      window.sms_orders.push({
        phone,
        customerName: name,
        orderNumber,
        storeType: document.getElementById('smsOrderStoreType').value,
        storeName: String(document.getElementById('smsOrderStoreName').value || '').trim(),
        pickupDeadline: document.getElementById('smsOrderDeadline').value
      });

      sms_syncToCloud();
      sms_renderOrders();
      sms_renderSendOrders();
      sms_closeModal('smsAddOrderModal');

      document.getElementById('smsOrderPhone').value = '';
      document.getElementById('smsOrderName').value = '';
      document.getElementById('smsOrderNumber').value = '';
      document.getElementById('smsOrderStoreName').value = '';
      document.getElementById('smsOrderDeadline').value = '';
    };

    window.sms_bulkImport = function() {
      const data = String(document.getElementById('smsBulkImportData').value || '').trim();
      if (!data) return alert('è«‹è²¼ä¸Šè³‡æ–™');

      const lines = data.split('\n');
      let imported = 0;

      lines.forEach(line => {
        const parts = line.split(/[\t,]/).map(p => p.trim());
        if (parts.length >= 2) {
          window.sms_orders.push({
            phone: sms_normalizePhone(parts[0]),
            customerName: parts[1] || '',
            orderNumber: sms_normalizeOrderNumber(parts[2] || ''),
            storeType: parts[3] || 'å…¨å®¶',
            storeName: parts[4] || '',
            pickupDeadline: parts[5] || ''
          });
          imported++;
        }
      });

      sms_syncToCloud();
      sms_renderOrders();
      sms_renderSendOrders();
      sms_closeModal('smsBulkImportModal');
      document.getElementById('smsBulkImportData').value = '';
      alert(`æˆåŠŸåŒ¯å…¥ ${imported} ç­†è¨‚å–®`);
    };

    window.sms_deleteOrder = function(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')) {
        window.sms_orders.splice(index, 1);
        sms_syncToCloud();
        sms_renderOrders();
        sms_renderSendOrders();
      }
    };

    window.sms_clearAllOrders = function() {
      if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        window.sms_orders = [];
        window.sms_selectedOrders.clear();
        window.sms_smsContent = {};
        sms_syncToCloud();
        sms_renderOrders();
        sms_renderSendOrders();
      }
    };

    window.sms_exportOrders = function() {
      const dataStr = JSON.stringify(window.sms_orders, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `è¨‚å–®è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    function sms_renderOrders() {
      const container = document.getElementById('smsOrdersList');
      if (!container) return;

      if (window.sms_orders.length === 0) {
        container.innerHTML = `
          <div class="sms-empty-state">
            <div class="sms-empty-state-icon">ğŸ“¦</div>
            <p>å°šç„¡è¨‚å–®è³‡æ–™</p>
            <p style="font-size: 14px; margin-top: 10px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢è¨‚å–®</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.sms_orders.map((order, index) => `
        <div class="sms-order-card">
          <div class="sms-order-header">
            <div style="font-size: 18px; font-weight: 900;">
              ${order.customerName}
              ${window.sms_smsContent[order.phone] ? '<span class="sms-badge sms-badge-draft">è‰ç¨¿</span>' : ''}
            </div>
            <button class="sms-btn sms-btn-danger sms-btn-small" onclick="sms_deleteOrder(${index})">åˆªé™¤</button>
          </div>
          <div class="sms-order-info">
            <div><strong>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</strong>${order.phone}</div>
            <div><strong>è¨‚å–®è™Ÿç¢¼ï¼š</strong>${sms_normalizeOrderNumber(order.orderNumber) || '-'}</div>
            <div><strong>å–è²¨é–€å¸‚ï¼š</strong>${order.storeType} ${order.storeName || ''}</div>
            <div><strong>å–è²¨æœŸé™ï¼š</strong>${sms_formatDateToMMDD(order.pickupDeadline) || '-'}</div>
          </div>
        </div>
      `).join('');
    }

    // ç¯„æœ¬æ“ä½œ
    window.sms_addTemplate = function() {
      const name = String(document.getElementById('smsTemplateName').value || '').trim();
      const content = String(document.getElementById('smsTemplateContent').value || '').trim();
      if (!name || !content) return alert('è«‹å¡«å¯«ç¯„æœ¬åç¨±å’Œå…§å®¹');

      window.sms_templates.push({ name, content });
      sms_syncToCloud();
      sms_renderTemplates();
      sms_updateTemplateSelect();
      sms_closeModal('smsAddTemplateModal');

      document.getElementById('smsTemplateName').value = '';
      document.getElementById('smsTemplateContent').value = '';
    };

    window.sms_deleteTemplate = function(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯„æœ¬å—ï¼Ÿ')) {
        window.sms_templates.splice(index, 1);
        sms_syncToCloud();
        sms_renderTemplates();
        sms_updateTemplateSelect();
      }
    };

    window.sms_exportTemplates = function() {
      const dataStr = JSON.stringify(window.sms_templates, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ç°¡è¨Šç¯„æœ¬_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    window.sms_importTemplates = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            window.sms_templates = imported;
            sms_syncToCloud();
            sms_renderTemplates();
            sms_updateTemplateSelect();
            alert('ç¯„æœ¬åŒ¯å…¥æˆåŠŸï¼');
          } catch {
            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    function sms_renderTemplates() {
      const container = document.getElementById('smsTemplatesList');
      if (!container) return;

      if (window.sms_templates.length === 0) {
        container.innerHTML = `
          <div class="sms-empty-state">
            <div class="sms-empty-state-icon">ğŸ’¬</div>
            <p>å°šç„¡ç°¡è¨Šç¯„æœ¬</p>
            <p style="font-size: 14px; margin-top: 10px;">é»æ“Šå³ä¸‹è§’ã€ŒğŸ”„ é‡ç½®ç¯„æœ¬ã€è¼‰å…¥é è¨­ç¯„æœ¬</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.sms_templates.map((template, index) => `
        <div class="sms-template-card">
          <div class="sms-template-header">
            <div class="sms-template-name">${template.name}</div>
            <button class="sms-btn sms-btn-danger sms-btn-small" onclick="sms_deleteTemplate(${index})">åˆªé™¤</button>
          </div>
          <div class="sms-template-content">${template.content}</div>
        </div>
      `).join('');
    }

    function sms_updateTemplateSelect() {
      const select = document.getElementById('smsTemplateSelect');
      if (!select) return;
      select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç¯„æœ¬ --</option>' +
        window.sms_templates.map((t, i) => `<option value="${i}">${t.name}</option>`).join('');
    }

    window.sms_previewTemplate = function() {
      const select = document.getElementById('smsTemplateSelect');
      const preview = document.getElementById('smsTemplatePreview');
      if (!select || !preview) return;

      if (select.value === '') { preview.value = ''; return; }
      const template = window.sms_templates[select.value];
      preview.value = template.content;
    };

    function sms_replacePlaceholders(template, order) {
      return template
        .replace(/{customerName}/g, order.customerName)
        .replace(/{orderNumber}/g, sms_normalizeOrderNumber(order.orderNumber) || '')
        .replace(/{storeType}/g, order.storeType)
        .replace(/{storeName}/g, order.storeName || '')
        .replace(/{pickupDeadline}/g, sms_formatDateToMMDD(order.pickupDeadline) || '');
    }

    // ç™¼é€é ï¼šé¸å–/è‰ç¨¿/ç™¼é€
    window.sms_toggleSelectAll = function() {
      const checked = document.getElementById('smsSelectAllOrders').checked;
      if (checked) window.sms_orders.forEach(order => window.sms_selectedOrders.add(order.phone));
      else window.sms_selectedOrders.clear();
      sms_renderSendOrders();
    };

    window.sms_toggleOrderSelection = function(phone) {
      if (window.sms_selectedOrders.has(phone)) window.sms_selectedOrders.delete(phone);
      else window.sms_selectedOrders.add(phone);
      sms_renderSendOrders();
    };

    window.sms_applyTemplateToSelected = function() {
      const content = String(document.getElementById('smsTemplatePreview').value || '').trim();
      if (!content) return alert('è«‹é¸æ“‡ç¯„æœ¬æˆ–è¼¸å…¥å…§å®¹');
      if (window.sms_selectedOrders.size === 0) return alert('è«‹å…ˆå‹¾é¸è¦ç™¼é€çš„å®¢æˆ¶');

      window.sms_selectedOrders.forEach(phone => {
        const order = window.sms_orders.find(o => o.phone === phone);
        if (order) window.sms_smsContent[phone] = sms_replacePlaceholders(content, order);
      });

      sms_renderSendOrders();
      sms_renderOrders();
      alert(`å·²å¥—ç”¨ç¯„æœ¬åˆ° ${window.sms_selectedOrders.size} ä½å®¢æˆ¶`);
    };

    window.sms_editSms = function(phone) {
      window.sms_currentEditingPhone = phone;
      const order = window.sms_orders.find(o => o.phone === phone);
      document.getElementById('smsEditSmsCustomer').textContent = order ? order.customerName : '';
      document.getElementById('smsEditSmsContent').value = window.sms_smsContent[phone] || '';
      document.getElementById('smsEditSmsModal').classList.add('active');
    };

    window.sms_saveEditedSms = function() {
      const content = String(document.getElementById('smsEditSmsContent').value || '').trim();
      if (content) {
        window.sms_smsContent[window.sms_currentEditingPhone] = content;
        sms_renderSendOrders();
        sms_renderOrders();
      }
      sms_closeModal('smsEditSmsModal');
    };

    window.sms_saveDrafts = function() {
      if (Object.keys(window.sms_smsContent).length === 0) return alert('æ²’æœ‰è¦å„²å­˜çš„è‰ç¨¿');
      localStorage.setItem('smsDrafts', JSON.stringify(window.sms_smsContent));
      sms_renderOrders();
      alert('è‰ç¨¿å·²å„²å­˜');
    };

    window.sms_startSending = async function() {
      const toSend = window.sms_orders.filter(o => window.sms_smsContent[o.phone]);
      if (toSend.length === 0) return alert('è«‹å…ˆå¥—ç”¨ç¯„æœ¬åˆ°å®¢æˆ¶');

      if (!confirm(`ç¢ºå®šè¦ç™¼é€ ${toSend.length} å‰‡ç°¡è¨Šå—ï¼Ÿ`)) return;

      for (let i = 0; i < toSend.length; i++) {
        const order = toSend[i];
        const message = window.sms_smsContent[order.phone];
        const smsUrl = `sms:${order.phone}?body=${encodeURIComponent(message)}`;
        window.open(smsUrl, '_blank');

        await sms_recordSendHistory(order.phone, message);
        sms_renderSendOrders();

        if (i < toSend.length - 1) {
          const shouldContinue = confirm(`å·²é–‹å•Ÿç¬¬ ${i + 1} å‰‡ç°¡è¨Š\n\nç¹¼çºŒç™¼é€ä¸‹ä¸€å‰‡ï¼Ÿ`);
          if (!shouldContinue) break;
        }
      }

      alert('ç™¼é€æµç¨‹å®Œæˆï¼');
    };

    window.sms_sendSingleMessage = async function(phone) {
      const message = window.sms_smsContent[phone];
      if (!message) return alert('è«‹å…ˆå¥—ç”¨ç¯„æœ¬');

      const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;
      window.open(smsUrl, '_blank');

      await sms_recordSendHistory(phone, message);
      sms_renderSendOrders();

      const toast = document.createElement('div');
      toast.textContent = 'âœ… å·²é–‹å•Ÿç°¡è¨Š App ä¸¦è¨˜éŒ„ç™¼é€';
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 900;
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    };

    function sms_renderSendOrders() {
      const container = document.getElementById('smsSendOrdersList');
      if (!container) return;

      if (window.sms_orders.length === 0) {
        container.innerHTML = `
          <div class="sms-empty-state">
            <div class="sms-empty-state-icon">ğŸ“¦</div>
            <p>å°šç„¡è¨‚å–®è³‡æ–™</p>
          </div>
        `;
        return;
      }

      container.innerHTML = window.sms_orders.map(order => {
        const isSelected = window.sms_selectedOrders.has(order.phone);
        const hasSms = window.sms_smsContent[order.phone];

        const hist = window.sms_sendHistory[order.phone];

        return `
          <div class="sms-order-card ${isSelected ? 'selected' : ''}">
            <div class="sms-order-header">
              <label class="sms-checkbox-label">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="sms_toggleOrderSelection('${order.phone}')">
                <span style="font-size: 18px; font-weight: 900;">${order.customerName} (${order.phone})</span>
              </label>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                ${hasSms ? `<button class="sms-btn sms-btn-warning sms-btn-small" onclick="sms_editSms('${order.phone}')">ç·¨è¼¯</button>` : ''}
                ${hasSms ? `<button class="sms-btn sms-btn-success sms-btn-small" onclick="sms_sendSingleMessage('${order.phone}')">ğŸ“¤ ç™¼é€è¨Šæ¯</button>` : ''}
              </div>
            </div>

            <div class="sms-order-info" style="grid-template-columns: 1fr 1fr 1fr;">
              <div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${sms_normalizeOrderNumber(order.orderNumber) || '-'}</div>
              <div><strong>å–ä»¶æœŸé™ï¼š</strong>${sms_formatDateToMMDD(order.pickupDeadline) || '-'}</div>
              <div><strong>é–€å¸‚ï¼š</strong>${order.storeType} ${order.storeName || ''}</div>
            </div>

            ${hasSms ? `
              <div class="sms-preview">
                <div class="sms-preview-label">ğŸ“± ç°¡è¨Šé è¦½</div>
                <div class="sms-preview-content">${window.sms_smsContent[order.phone]}</div>
              </div>
            ` : ''}

            ${hist ? `
              <div class="sms-send-history">
                <div class="sms-send-history-header">ğŸ“¤ ç™¼é€è¨˜éŒ„</div>
                <div class="sms-send-history-summary">
                  <span>å·²ç™¼é€ <strong>${hist.sendCount || 0}</strong> æ¬¡</span>
                  <span>æœ€å¾Œç™¼é€ï¼š<strong>${hist.lastSentAt ? sms_formatDateTime(hist.lastSentAt) : '-'}</strong></span>
                </div>
                ${hist.history && hist.history.length > 0 ? `
                  <div class="sms-send-history-list">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ç™¼é€æ™‚é–“ï¼š</div>
                    ${hist.history.slice(0, 5).map(h => `
                      <div class="sms-history-item">âœ… ${sms_formatDateTime(h.sentAt)}</div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // åˆå§‹æ¸²æŸ“ï¼ˆè®“é é¢ä¸ç©ºï¼‰
    sms_renderOrders();
    sms_renderTemplates();
    sms_updateTemplateSelect();
    sms_renderSendOrders();
    sms_updateSyncStatus();
  </script>
</body>
</html>
